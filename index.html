<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Permissions-Policy" content="camera=*, microphone=*, geolocation=*">
    <meta http-equiv="Feature-Policy" content="camera *; microphone *; geolocation *">
    <meta name="theme-color" content="#FFC300">
    <meta name="mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('‚úÖ Service Worker registrado'))
                .catch(err => console.error('‚ùå Error SW:', err));
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        eruda.init();
        console.log('‚úÖ Eruda inicializado correctamente');
    </script>
    <title>Panel Repartidor - v1.8.0 OPTIMIZADO</title>
    <style>
        :root {
            --color-primary: #FFC300;
            --color-secondary: #D7D7D7;
            --color-background: #111111;
            --color-accent-danger: #C0392B;
            --color-waiting: #E67E22;
            --color-delivery: #2980B9;
            --color-card: #222222;
        }
        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--color-background);
            color: var(--color-secondary);
        }
        #loginContainer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--color-background);
            z-index: 2000; display: flex; 
            justify-content: center; align-items: center; flex-direction: column;
        }
        #loginContainer > div {
            background: #222222;
            padding: 30px; border-radius: 10px; 
            box-shadow: 0 0 20px rgba(255,195,0,0.3);
            width: 90%; max-width: 350px;
        }
        #loginContainer input {
            background: #333;
            color: white;
            border: 1px solid #444;
            width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; box-sizing: border-box;
        }
        #loginContainer button {
            width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 10px; border-radius: 4px; box-sizing: border-box;
            background: var(--color-primary);
            color: var(--color-background);
            border: none; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s;
        }
        #loginContainer button:hover {
            background: #e6b200;
        }
        #loginContainer button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #registrationForm h3, #registrationForm p {
            color: var(--color-primary);
            text-align: center;
        }
        #registrationForm label {
            font-size: 0.9em; display: block; margin-top: 10px; margin-bottom: 5px;
            color: var(--color-secondary);
        }
        #quickLoginArea {
            margin-top: 15px; 
            border-top: 1px solid #444; 
            padding-top: 10px; 
            text-align: center;
        }
        #appContainer { display: none; max-width: 900px; margin: 20px auto; padding: 20px; }
        h2, h3 { color: var(--color-secondary); }
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px;
            margin: 20px 0;
        }
        .nav-buttons button {
            padding: 10px 5px; 
            border: none; 
            color: var(--color-background);
            border-radius: 5px; 
            font-weight: bold;
            position: relative;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .nav-buttons button:hover {
            opacity: 0.9;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--color-accent-danger);
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 0.7em;
            line-height: 1;
            display: none; 
        }
        .pedidos-list {
            background: #222222;
            padding: 15px; border-radius: 10px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); 
            margin-top: 20px;
        }
        .pedido-item {
            padding: 10px; border-bottom: 1px solid #333; margin-bottom: 10px;
            background: #333333; 
            border-left: 5px solid var(--color-accent-danger);
            color: var(--color-secondary);
            position: relative; 
            border-radius: 4px;
        }
        .pedido-item.asignado { border-left: 5px solid var(--color-primary); background: #444444; }
        .pedido-item.esperando { border-left: 5px solid var(--color-waiting); }
        .pedido-item.en-camino { border-left: 5px solid var(--color-delivery); }
        .pedido-item strong { color: var(--color-primary); }
        .pedido-item button { 
            border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-top: 5px; 
            font-weight: bold;
            transition: opacity 0.2s;
        }
        .pedido-item button:hover {
            opacity: 0.8;
        }
        .pedido-item .timer {
            font-size: 1.2em; font-weight: bold; color: var(--color-primary);
            margin-top: 5px; display: block;
        }
        #mapa-cliente-container {
            margin-top: 20px;
            background: var(--color-card);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #mapa-cliente {
            width: 100%;
            height: 400px;
            margin: 15px 0;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--color-primary);
            position: relative;
            z-index: 1;
        }
        .custom-marker-cliente,
        .custom-marker-repartidor {
            width: 40px !important;
            height: 40px !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        .custom-marker-cliente > div,
        .custom-marker-repartidor > div {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .map-legend {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        .map-legend > div {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .map-info-box {
            background: var(--color-card);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }
        .map-info-box strong {
            color: var(--color-primary);
            display: block;
            margin-bottom: 5px;
        }
        .map-info-box p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        #cancelModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000;
            display: none; justify-content: center; align-items: center;
        }
        #cancelModalContent {
            background: #222222; 
            color: var(--color-secondary);
            padding: 20px; border-radius: 8px; width: 90%; max-width: 300px; text-align: center;
        }
        #cancelModalContent button {
            background: var(--color-accent-danger); 
            margin-top: 10px; margin-bottom: 5px;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        #cancelModalContent button:hover {
            opacity: 0.8;
        }
        .chat-box {
             background: #222222; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); margin-top: 20px;
        }
        .mensajes-area { 
            max-height: 400px; 
            overflow-y: auto; 
            padding: 10px; 
            border: 1px solid #444; 
            border-radius: 5px; 
            background: #1a1a1a;
        }
        .mensaje { 
            padding: 8px 12px; 
            border-radius: 12px; 
            margin: 5px 0; 
            max-width: 80%; 
            word-wrap: break-word;
            clear: both;
        }
        .admin-msg { 
            background-color: var(--color-primary);
            color: var(--color-background); 
            float: left;
            margin-right: auto; 
        }
        .rep-msg { 
            background-color: #555555;
            color: white; 
            float: right;
            margin-left: auto; 
        }
        .chat-time { 
            font-size: 10px; 
            margin-top: 3px; 
            display: block; 
            text-align: right; 
            color: rgba(0, 0, 0, 0.7); 
        }
        .rep-msg .chat-time { 
            color: rgba(255, 255, 255, 0.7); 
        }
        .mensaje img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 5px;
            display: block;
            cursor: pointer;
        }
        .mensaje audio {
            width: 100%;
            max-width: 250px;
            margin-top: 5px;
            display: block;
        }
        .media-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .media-controls button {
            background: #444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        .media-controls button:hover {
            background: #555;
        }
        .media-controls button.active {
            background: var(--color-accent-danger);
        }
        .media-controls input[type="file"] {
            display: none;
        }
        .recording-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--color-accent-danger);
            color: white;
            border-radius: 5px;
            margin-top: 10px;
        }
        .recording-indicator.active {
            display: flex;
        }
        .recording-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .image-preview {
            display: none;
            margin-top: 10px;
            position: relative;
        }
        .image-preview.active {
            display: block;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 5px;
        }
        .image-preview button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--color-accent-danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }
        #imageModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        #imageModal.active {
            display: flex;
        }
        #imageModal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        #imageModal button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--color-accent-danger);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
        }
        .upload-progress {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #333;
            border-radius: 5px;
            text-align: center;
        }
        .upload-progress.active {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #444;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            width: 0%;
            transition: width 0.3s;
        }
        .gps-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.5);
            animation: pulse-gps 2s infinite;
        }
        .gps-indicator.active {
            display: flex;
        }
        @keyframes pulse-gps {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .gps-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .gps-indicator-repartidor {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #2196F3;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.85em;
            font-weight: bold;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);
            animation: pulse-gps 2s infinite;
        }
        .gps-indicator-repartidor.active {
            display: flex;
        }
        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
        }
        .connection-status.active {
            display: flex;
        }
        .connection-status.offline {
            background: #C0392B;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        #permisosModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 15000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        #permisosModal.show {
            display: flex;
        }
        .permisos-content {
            background: #222;
            padding: 30px;
            border-radius: 15px;
            max-width: 450px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(255, 195, 0, 0.3);
        }
        .permisos-content h2 {
            color: var(--color-primary);
            margin-bottom: 20px;
        }
        .permisos-content p {
            color: var(--color-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .permisos-list {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            background: #333;
            border-radius: 10px;
        }
        .permiso-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 10px;
            background: #444;
            border-radius: 8px;
        }
        .permiso-icon {
            font-size: 32px;
            width: 50px;
            text-align: center;
        }
        .permiso-info {
            flex: 1;
        }
        .permiso-info strong {
            color: var(--color-primary);
            display: block;
            margin-bottom: 5px;
        }
        .permiso-info small {
            color: #999;
            font-size: 0.85em;
        }
        .permisos-warning {
            background: rgba(230, 126, 34, 0.2);
            border: 1px solid #E67E22;
            color: #E67E22;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.9em;
        }
        .permisos-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        .permisos-buttons button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-permitir {
            background: var(--color-primary);
            color: var(--color-background);
        }
        .btn-permitir:hover {
            background: #e6b200;
            transform: translateY(-2px);
        }
        .btn-omitir {
            background: #555;
            color: white;
        }
        .btn-omitir:hover {
            background: #666;
        }
    </style>
</head>
<body>
<div id="connectionStatus" class="connection-status">
    <div class="status-dot"></div>
    <span id="connectionText">üü¢ Online</span>
</div>
<div id="gpsIndicator" class="gps-indicator">
    <div class="gps-dot"></div>
    <span>üìç GPS Activo (15s)</span>
</div>
<div id="gps-indicator-repartidor" class="gps-indicator-repartidor">
    <div class="gps-dot"></div>
    <span>üèçÔ∏è GPS Activo (15s)</span>
</div>
<div id="permisosModal">
    <div class="permisos-content">
        <h2>üîê Permisos Necesarios</h2>
        <p>Para usar todas las funciones necesitamos acceso a:</p>
        <div class="permisos-list">
            <div class="permiso-item">
                <div class="permiso-icon">üìç</div>
                <div class="permiso-info">
                    <strong>Ubicaci√≥n GPS</strong>
                    <small>Tracking cada 15 segundos (optimizado)</small>
                </div>
            </div>
            <div class="permiso-item">
                <div class="permiso-icon">üì∑</div>
                <div class="permiso-info">
                    <strong>C√°mara/Galer√≠a</strong>
                    <small>Para enviar fotos en el chat</small>
                </div>
            </div>
            <div class="permiso-item">
                <div class="permiso-icon">üé§</div>
                <div class="permiso-info">
                    <strong>Micr√≥fono</strong>
                    <small>Para grabar y enviar audios</small>
                </div>
            </div>
        </div>
        <div class="permisos-warning">
            ‚ö†Ô∏è <strong>Importante:</strong> El GPS se activar√° autom√°ticamente y enviar√° tu ubicaci√≥n cada 15 segundos para optimizar costos de Firebase.
        </div>
        <div class="permisos-buttons">
            <button class="btn-permitir" onclick="solicitarTodosLosPermisos()">
                ‚úÖ Permitir Todo
            </button>
            <button class="btn-omitir" onclick="omitirPermisos()">
                ‚è≠Ô∏è Continuar sin permisos
            </button>
        </div>
    </div>
</div>
<div id="loginContainer">
    <div id="manualLoginForm">
        <h3 style="text-align: center; color: var(--color-primary);">Bienvenido</h3>
        <p style="text-align: center; font-size: 0.9em; margin-bottom: 20px;">
            Inicia sesi√≥n o reg√≠strate con tu correo y contrase√±a:
        </p>
        <label style="font-size: 0.8em; display: block; margin-bottom: 5px; color: var(--color-secondary);">Correo Electr√≥nico:</label>
        <input type="email" id="loginEmail" placeholder="tu.correo@ejemplo.com">
        <label style="font-size: 0.8em; display: block; margin-bottom: 5px; color: var(--color-secondary);">Contrase√±a:</label>
        <input type="password" id="loginPassword" placeholder="Contrase√±a (M√≠n. 6 caracteres)">
        <button id="registerBtn">
            Registrarse (Crear Cuenta)
        </button>
        <button id="loginBtn" style="background: var(--color-primary); color: var(--color-background);">
            Iniciar Sesi√≥n
        </button>
        <p id="loginError" style="color: var(--color-accent-danger); margin-top: 10px; text-align: center;"></p>
        <div id="quickLoginArea" style="display: none;">
            <p id="quickLoginMessage" style="margin-bottom: 5px; font-size: 0.9em; color: var(--color-primary);"></p>
            <button id="quickLoginBtn" style="background: var(--color-primary); color: var(--color-background); border: none;">Entrar R√°pido (Un Clic)</button>
        </div>
    </div>
    <div id="registrationForm" style="display:none;">
        <h3 style="color: var(--color-primary);">Completa tu Registro</h3>
        <p style="font-size: 0.9em; margin-bottom: 15px;">
            Falta informaci√≥n esencial para solicitar domicilios.
        </p>
        <label>Nombre completo: *</label>
        <input type="text" id="regName" placeholder="Tu Nombre Completo">
        <label>Correo Electr√≥nico:</label>
        <input type="email" id="regEmailDisplay" placeholder="Email (no editable)" disabled style="color: #999;">
        <label>Tel√©fono principal: *</label>
        <input type="text" id="regPhone" placeholder="Tu N√∫mero de Tel√©fono (√önico)">
        <label>Tel√©fono secundario (opcional):</label>
        <input type="text" id="regSecondaryPhone" placeholder="Otro N√∫mero de Contacto">
        <label>Direcci√≥n de residencia: *</label>
        <input type="text" id="regAddress" placeholder="Direcci√≥n de tu Residencia">
        <button id="completeRegBtn" style="background: var(--color-primary); color: var(--color-background); margin-top: 20px;">Guardar y Continuar</button>
        <button id="regLogoutBtn" style="background: #555555; color: white;">Cerrar Sesi√≥n</button>
    </div>
</div>
<div id="appContainer">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
        <h2 style="color: var(--color-secondary); margin: 0;">Bienvenido, <span id="repartidorName"></span>!</h2>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <span id="appVersionDisplay" style="background: #27ae60; color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: bold;">
                v1.8.0
            </span>
            <button id="verMapaBtn" style="padding: 8px 15px; background: #2196F3; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                üó∫Ô∏è Ver Mapa Cliente
            </button>
            <button id="logoutBtn" style="padding: 8px 15px; background: var(--color-accent-danger); color: white; border: none; border-radius: 5px; font-weight: bold;">
                Cerrar Sesi√≥n
            </button>
        </div>
    </div>
    <div class="nav-buttons">
        <button id="showChatBtn" style="background: var(--color-primary);">üí¨ Chat</button>
        <button id="showPendientesBtn" style="background: var(--color-accent-danger);">
            üì¶ Pendientes <span id="pendientesBadge" class="notification-badge">!</span>
        </button>
        <button id="showAsignadosBtn" style="background: var(--color-primary);">üöö Asignados (<span id="asignadosCount">0</span>)</button>
        <button id="showHistorialBtn" style="background: var(--color-secondary); color: var(--color-background);">üìú Historial</button>
    </div>
    <div id="chatSection">
        <h3 style="color: var(--color-secondary);">üí¨ Chat con Administrador</h3>
        <div class="chat-box">
            <div class="mensajes-area" id="chatBox">Esperando mensaje del Admin...</div>
            <div class="media-controls">
                <button id="sendGalleryBtn" title="Seleccionar foto de galer√≠a">üñºÔ∏è Galer√≠a</button>
                <button id="recordAudioBtn" title="Grabar audio">üé§ Grabar Audio</button>
                <input type="file" id="galleryInput" accept="image/*" style="display: none;">
            </div>
            <div class="audio-preview" id="audioPreview" style="display: none; margin-top: 10px; padding: 10px; background: #333; border-radius: 5px;">
                <p style="color: #FFC300; margin: 0 0 5px 0;">üé§ Audio grabado:</p>
                <audio id="previewAudio" controls style="width: 100%; max-width: 300px;"></audio>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="sendAudioFileBtn" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; flex: 1;">‚úÖ Enviar Audio</button>
                    <button id="cancelAudioBtn" style="background: var(--color-accent-danger); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">‚úï Cancelar</button>
                </div>
            </div>
            <div class="recording-indicator" id="recordingIndicator">
                <div class="recording-dot"></div>
                <span id="recordingTimer">00:00</span>
                <button id="stopRecordingBtn" style="background: var(--color-accent-danger); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Detener</button>
            </div>
            <div class="image-preview" id="imagePreview">
                <img id="previewImg" src="" alt="Preview">
                <button id="cancelImageBtn">‚úï</button>
            </div>
            <div class="upload-progress" id="uploadProgress">
                <p>Subiendo archivo...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">0%</p>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" id="mensajeInput" placeholder="Escribe un mensaje..." style="flex-grow: 1; background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 5px;">
                <button id="enviarBtn" style="background: var(--color-primary); color: var(--color-background); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Enviar</button>
            </div>
        </div>
    </div>
    <div id="pendientesSection" style="display:none;">
        <h3 style="color: var(--color-secondary);">üì¶ Nuevos Pedidos (Pendientes)</h3>
        <div class="pedidos-list" id="pedidosList">Cargando pedidos pendientes...</div>
    </div>
    <div id="asignadosSection" style="display:none;">
        <h3 style="color: var(--color-secondary);">üöö Mis Pedidos Asignados</h3>
        <div id="mapa-cliente-container" style="display: none;">
            <h4 style="color: var(--color-primary); margin-top: 20px;">üó∫Ô∏è Ubicaci√≥n del Cliente</h4>
            <div id="mapa-cliente"></div>
            <div class="map-legend">
                <div>
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #4CAF50;"></div>
                    <span>üìç Cliente</span>
                </div>
                <div>
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #2196F3;"></div>
                    <span>üèçÔ∏è T√∫</span>
                </div>
            </div>
            <div class="map-info-box">
                <strong>üìä Informaci√≥n de Navegaci√≥n</strong>
                <p id="distancia-cliente">üìè Calculando distancia...</p>
                <p id="direccion-cliente">üß≠ Calculando direcci√≥n...</p>
            </div>
        </div>
        <div class="pedidos-list" id="pedidosAsignadosList">No tienes pedidos asignados actualmente.</div>
    </div>
    <div id="historialSection" style="display:none;">
        <h3 style="color: var(--color-secondary);">üìú Historial de Domicilios Completados/Cancelados</h3>
        <div class="pedidos-list" id="pedidosHistorialList">Cargando historial...</div>
    </div>
</div>
<div id="cancelModal">
    <div id="cancelModalContent">
        <h4>¬øPor qu√© deseas cancelar este domicilio?</h4>
        <div id="motivosContainer">
            <button onclick="window.ejecutarCancelacionConMotivo('Env√≠o/Domicilio mal tomado')" style="background: var(--color-accent-danger); width: 100%;">Env√≠o/Domicilio mal tomado</button>
            <button onclick="window.ejecutarCancelacionConMotivo('Me var√© (Problemas con el veh√≠culo)')" style="background: var(--color-accent-danger); width: 100%;">Me var√© (Problemas con el veh√≠culo)</button>
            <button onclick="window.ejecutarCancelacionConMotivo('Fin de turno/No puedo cubrirlo')" style="background: var(--color-accent-danger); width: 100%;">Fin de turno/No puedo cubrirlo</button>
            <button onclick="window.ejecutarCancelacionConMotivo('Correcci√≥n de datos / Contacto fallido')" style="background: var(--color-accent-danger); width: 100%;">Correcci√≥n de datos / Contacto fallido</button>
        </div>
        <button onclick="document.getElementById('cancelModal').style.display='none';" style="background: #555555; width: 100%; margin-top: 15px; color: white;">Cerrar</button>
    </div>
</div>
<div id="imageModal">
    <button onclick="document.getElementById('imageModal').classList.remove('active');">‚úï Cerrar</button>
    <img id="modalImage" src="" alt="Imagen completa">
</div>
<audio id="notificationSound" src="https://github.com/dt9650329-ops/Chat-administrador-/raw/f67a159f93aed6be1d6f7f02709384111cd84b7e/%E2%9C%A8Monedas%20Cayendo%20__%20Efectos%20De%20Sonidos(MP3_160K).mp3" preload="auto"></audio>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, update, get, remove, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    const firebaseConfig = {
      apiKey: "AIzaSyAZX7Q5B29Xti4YtV9wXuiREVdkgcclv9U",
      authDomain: "domicilios-1cd74.firebaseapp.com",
      databaseURL: "https://domicilios-1cd74-default-rtdb.firebaseio.com",
      projectId: "domicilios-1cd74",
      storageBucket: "domicilios-1cd74.firebasestorage.app",
      messagingSenderId: "771819437001",
      appId: "1:771819437001:web:b9c8f5e4d3a2c1b0a1b2c3"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    window.db = db;
    window.ref = ref;
    window.update = update;
    window.get = get;
    window.onValue = onValue;
    window.off = off;
    const APP_VERSION = "1.8.0";
    window.addEventListener('DOMContentLoaded', () => {
        const versionDisplay = document.getElementById('appVersionDisplay');
        if (versionDisplay) {
            versionDisplay.textContent = `v${APP_VERSION}`;
        }
    });
    let repartidorUID = null;
    let repartidorNombre = "Repartidor";
    let timerInterval = null; 
    let currentPedidoIdToCancel = null; 
    let initialLoad = true;
    window.currentRepartidorUID = null;
    window.currentRepartidorNombre = null;
    window.currentClienteID = null;
    let selectedImageFile = null;
    let selectedAudioFile = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let watchId = null;
    let lastLocationUpdate = 0;
    const LOCATION_UPDATE_INTERVAL = 15000; // üî• 15 SEGUNDOS (optimizado)
    let isTrackingEnabled = false;
    let pedidosActivos = {};
    let gpsErrorCount = 0;
    const MAX_GPS_ERRORS = 3;
    let heartbeatInterval = null;
    let sessionActive = false;
    let wakeLock = null;
    let isWakeLockSupported = 'wakeLock' in navigator;
    let locationSendInterval = null;
    let backgroundGeoInterval = null;
    let isBackgroundMode = false;
    let permisosMultimediaOtorgados = false;
    let permisosCamaraOtorgado = false;
    let permisosMicrofonoOtorgado = false;
    let permisosUbicacionOtorgado = false;
    // üî• VARIABLES DEL MAPA (OPTIMIZADAS)
    let mapaCliente = null;
    let marcadorCliente = null;
    let marcadorRepartidor = null;
    let clienteUbicacionListener = null;
    let repartidorCoords = null;
    let clienteCoordsRepartidorApp = null;
    let repartidorLocationWatchId = null;
    let isRepartidorLocationActive = false;
    let lastRepartidorLocationUpdate = 0;
    const REPARTIDOR_LOCATION_INTERVAL = 15000; // üî• 15 SEGUNDOS
    // üÜï VARIABLE PARA GUARDAR EL PEDIDO ACTIVO Y PERSISTIR UBICACI√ìN
    let activePedidoData = null;
    // ========================================
    // üÜï FUNCIONES PARA PERSISTIR UBICACI√ìN DEL CLIENTE
    // ========================================
    function guardarUbicacionClienteEnStorage(clienteID, coords) {
        try {
            const data = {
                clienteID: clienteID,
                coords: coords,
                timestamp: Date.now()
            };
            localStorage.setItem('cliente_ubicacion_activa', JSON.stringify(data));
            console.log('üíæ Ubicaci√≥n del cliente guardada en localStorage:', data);
        } catch (error) {
            console.error('‚ùå Error al guardar ubicaci√≥n en localStorage:', error);
        }
    }
    function cargarUbicacionClienteDeStorage() {
        try {
            const data = localStorage.getItem('cliente_ubicacion_activa');
            if (data) {
                const parsed = JSON.parse(data);
                console.log('üìÇ Ubicaci√≥n del cliente cargada desde localStorage:', parsed);
                return parsed;
            }
        } catch (error) {
            console.error('‚ùå Error al cargar ubicaci√≥n desde localStorage:', error);
        }
        return null;
    }
    function limpiarUbicacionClienteDeStorage() {
        try {
            localStorage.removeItem('cliente_ubicacion_activa');
            console.log('üóëÔ∏è Ubicaci√≥n del cliente eliminada de localStorage');
        } catch (error) {
            console.error('‚ùå Error al limpiar ubicaci√≥n de localStorage:', error);
        }
    }
    // ========================================
    // FUNCIONES DE DEBUGGING MEJORADAS
    // ========================================
    function logDebugCliente(mensaje, datos = null) {
        console.log(`üîç [CLIENTE] ${mensaje}`, datos || '');
    }
    function logDebugRepartidor(mensaje, datos = null) {
        console.log(`üèçÔ∏è [REPARTIDOR] ${mensaje}`, datos || '');
    }
    function logDebugMapa(mensaje, datos = null) {
        console.log(`üó∫Ô∏è [MAPA] ${mensaje}`, datos || '');
    }
    // ========================================
    // INICIALIZAR MAPA
    // ========================================
    function inicializarMapaCliente() {
        logDebugMapa('Inicializando mapa del cliente...');
        if (mapaCliente) {
            logDebugMapa('Removiendo mapa existente');
            mapaCliente.remove();
            mapaCliente = null;
            marcadorCliente = null;
            marcadorRepartidor = null;
        }
        const defaultCoords = [4.710989, -74.072092];
        try {
            mapaCliente = L.map('mapa-cliente', {
                center: defaultCoords,
                zoom: 13,
                zoomControl: true,
                attributionControl: true
            });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(mapaCliente);
            setTimeout(() => {
                if (mapaCliente) {
                    mapaCliente.invalidateSize();
                    logDebugMapa('Tama√±o del mapa actualizado');
                }
            }, 300);
            logDebugMapa('‚úÖ Mapa del cliente inicializado correctamente');
        } catch (error) {
            console.error('‚ùå Error al inicializar mapa:', error);
        }
    }
    // ========================================
    // üî• AGREGAR MARCADOR DEL CLIENTE (CORREGIDO CON "lon")
    // ========================================
    function agregarMarcadorClienteEnMapaRepartidor(coords) {
        logDebugCliente('Intentando agregar marcador del cliente', coords);
        // üî• VALIDAR QUE COORDS TENGA "lon" (NO "lng")
        if (!coords || !coords.lat || !coords.lon) {
            console.error('‚ùå Coordenadas del cliente inv√°lidas:', coords);
            return;
        }
        const lat = parseFloat(coords.lat);
        const lon = parseFloat(coords.lon);
        if (isNaN(lat) || isNaN(lon)) {
            console.error('‚ùå Coordenadas del cliente son NaN:', coords);
            return;
        }
        if (lat === 0 && lon === 0) {
            console.warn('‚ö†Ô∏è Coordenadas en (0, 0) - ubicaci√≥n inv√°lida');
            return;
        }
        if (!mapaCliente) {
            console.error('‚ùå Mapa no inicializado');
            inicializarMapaCliente();
            setTimeout(() => agregarMarcadorClienteEnMapaRepartidor(coords), 500);
            return;
        }
        clienteCoordsRepartidorApp = coords;
        // üÜï GUARDAR EN LOCALSTORAGE
        if (window.currentClienteID) {
            guardarUbicacionClienteEnStorage(window.currentClienteID, coords);
        }
        try {
            if (marcadorCliente) {
                logDebugCliente('Actualizando marcador existente');
                marcadorCliente.setLatLng([lat, lon]);
            } else {
                logDebugCliente('Creando nuevo marcador del cliente');
                const iconCliente = L.divIcon({
                    className: 'custom-marker-cliente',
                    html: '<div style="background-color: #4CAF50; width: 35px; height: 35px; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 18px;">üìç</div>',
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                });
                marcadorCliente = L.marker([lat, lon], { 
                    icon: iconCliente,
                    title: 'Cliente'
                }).addTo(mapaCliente);
                marcadorCliente.bindPopup('<b>üìç Cliente</b><br>Ubicaci√≥n actual');
                logDebugCliente('‚úÖ Marcador del cliente agregado al mapa');
                // Centrar mapa en el cliente
                mapaCliente.setView([lat, lon], 15);
            }
            // Actualizar informaci√≥n de distancia si ya tenemos ubicaci√≥n del repartidor
            if (repartidorCoords) {
                calcularDistanciaYDireccion();
            } else {
                document.getElementById('distancia-cliente').textContent = 'üìè Esperando tu ubicaci√≥n GPS...';
                document.getElementById('direccion-cliente').textContent = 'üß≠ Activando GPS del repartidor...';
            }
        } catch (error) {
            console.error('‚ùå Error al agregar marcador del cliente:', error);
        }
    }
    // ========================================
    // AGREGAR MARCADOR DEL REPARTIDOR
    // ========================================
    function agregarMarcadorRepartidorEnMapa(coords) {
        logDebugRepartidor('Intentando agregar marcador del repartidor', coords);
        if (!coords || !coords.lat || !coords.lon) {
            console.error('‚ùå Coordenadas del repartidor inv√°lidas:', coords);
            return;
        }
        const lat = parseFloat(coords.lat);
        const lon = parseFloat(coords.lon);
        if (isNaN(lat) || isNaN(lon)) {
            console.error('‚ùå Coordenadas del repartidor son NaN:', coords);
            return;
        }
        if (!mapaCliente) {
            console.warn('‚ö†Ô∏è Mapa no inicializado, esperando...');
            return;
        }
        repartidorCoords = coords;
        try {
            if (marcadorRepartidor) {
                logDebugRepartidor('Actualizando marcador existente');
                marcadorRepartidor.setLatLng([lat, lon]);
            } else {
                logDebugRepartidor('Creando nuevo marcador del repartidor');
                const iconRepartidor = L.divIcon({
                    className: 'custom-marker-repartidor',
                    html: '<div style="background-color: #2196F3; width: 35px; height: 35px; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 18px;">üèçÔ∏è</div>',
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                });
                marcadorRepartidor = L.marker([lat, lon], { 
                    icon: iconRepartidor,
                    title: 'T√∫ (Repartidor)'
                }).addTo(mapaCliente);
                marcadorRepartidor.bindPopup('<b>üèçÔ∏è T√∫</b><br>Tu ubicaci√≥n actual');
                logDebugRepartidor('‚úÖ Marcador del repartidor agregado al mapa');
            }
            // Actualizar informaci√≥n de distancia si ya tenemos ubicaci√≥n del cliente
            if (clienteCoordsRepartidorApp) {
                calcularDistanciaYDireccion();
            }
        } catch (error) {
            console.error('‚ùå Error al agregar marcador del repartidor:', error);
        }
    }
    // ========================================
    // CALCULAR DISTANCIA Y DIRECCI√ìN
    // ========================================
    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Radio de la Tierra en metros
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c; // Distancia en metros
    }
    function calcularDireccion(lat1, lon1, lat2, lon2) {
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
        const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
        const x = Math.cos(œÜ1) * Math.sin(œÜ2) - Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
        const Œ∏ = Math.atan2(y, x);
        const bearing = (Œ∏ * 180 / Math.PI + 360) % 360;
        const directions = ['Norte ‚¨ÜÔ∏è', 'Noreste ‚ÜóÔ∏è', 'Este ‚û°Ô∏è', 'Sureste ‚ÜòÔ∏è', 'Sur ‚¨áÔ∏è', 'Suroeste ‚ÜôÔ∏è', 'Oeste ‚¨ÖÔ∏è', 'Noroeste ‚ÜñÔ∏è'];
        const index = Math.round(bearing / 45) % 8;
        return directions[index];
    }
    function calcularDistanciaYDireccion() {
        if (!clienteCoordsRepartidorApp || !repartidorCoords) {
            logDebugMapa('‚ö†Ô∏è No se pueden calcular distancia/direcci√≥n: faltan coordenadas');
            return;
        }
        try {
            const distancia = calcularDistancia(
                repartidorCoords.lat, repartidorCoords.lon,
                clienteCoordsRepartidorApp.lat, clienteCoordsRepartidorApp.lon
            );
            const direccion = calcularDireccion(
                repartidorCoords.lat, repartidorCoords.lon,
                clienteCoordsRepartidorApp.lat, clienteCoordsRepartidorApp.lon
            );
            const distanciaKm = (distancia / 1000).toFixed(2);
            const tiempoEstimado = Math.round(distancia / (30000 / 60)); // 30 km/h promedio
            document.getElementById('distancia-cliente').textContent = 
                `üìè Distancia: ${distanciaKm} km (${tiempoEstimado} min aprox.)`;
            document.getElementById('direccion-cliente').textContent = 
                `üß≠ Direcci√≥n: ${direccion}`;
            logDebugMapa(`üìä Distancia: ${distanciaKm} km, Direcci√≥n: ${direccion}`);
            // Ajustar zoom del mapa para mostrar ambos marcadores
            if (mapaCliente && marcadorCliente && marcadorRepartidor) {
                const bounds = L.latLngBounds([
                    [clienteCoordsRepartidorApp.lat, clienteCoordsRepartidorApp.lon],
                    [repartidorCoords.lat, repartidorCoords.lon]
                ]);
                mapaCliente.fitBounds(bounds, { padding: [50, 50] });
            }
        } catch (error) {
            console.error('‚ùå Error al calcular distancia/direcci√≥n:', error);
        }
    }
    // ========================================
    // üî• INICIAR SEGUIMIENTO DEL CLIENTE (CORREGIDO CON "lon" Y PERSISTENCIA)
    // ========================================
    function iniciarSeguimientoCliente(clienteID) {
        console.log('');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üëÅÔ∏è INICIANDO SEGUIMIENTO DEL CLIENTE v1.8.0');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        logDebugCliente(`Cliente ID recibido: ${clienteID}`);
        if (!clienteID) {
            console.error('‚ùå ERROR CR√çTICO: clienteID es null o undefined');
            alert('‚ö†Ô∏è Error: No se pudo obtener el ID del cliente. El mapa no mostrar√° su ubicaci√≥n.');
            return;
        }
        window.currentClienteID = clienteID;
        // üÜï INTENTAR CARGAR UBICACI√ìN GUARDADA PRIMERO
        const ubicacionGuardada = cargarUbicacionClienteDeStorage();
        if (ubicacionGuardada && ubicacionGuardada.clienteID === clienteID) {
            console.log('üìÇ Restaurando ubicaci√≥n del cliente desde localStorage');
            agregarMarcadorClienteEnMapaRepartidor(ubicacionGuardada.coords);
        }
        // Detener listener anterior si existe
        if (clienteUbicacionListener) {
            try {
                off(ref(db, `usuarios/${clienteID}`), 'value', clienteUbicacionListener);
                logDebugCliente('üõë Listener anterior detenido');
            } catch (error) {
                console.warn('‚ö†Ô∏è Error al detener listener anterior:', error);
            }
        }
        // üî• USAR "usuarios/" (NO "users/")
        const clienteRef = ref(db, `usuarios/${clienteID}`);
        logDebugCliente(`‚úÖ Usando ruta correcta: usuarios/${clienteID}`);
        try {
            clienteUbicacionListener = onValue(clienteRef, (snapshot) => {
                logDebugCliente('üì° Snapshot recibido del cliente');
                if (!snapshot.exists()) {
                    console.warn('‚ö†Ô∏è Datos del cliente no disponibles en Firebase');
                    console.warn(`‚ö†Ô∏è Ruta intentada: usuarios/${clienteID}`);
                    document.getElementById('distancia-cliente').textContent = 'üìè Cliente no encontrado en la base de datos';
                    return;
                }
                const clienteData = snapshot.val();
                logDebugCliente('üìä Datos completos del cliente:', clienteData);
                if (!clienteData.gpsActivo) {
                    console.warn('‚ö†Ô∏è GPS del cliente no est√° activo');
                    console.warn('   gpsActivo:', clienteData.gpsActivo);
                    document.getElementById('distancia-cliente').textContent = 'üìè GPS del cliente desactivado';
                    document.getElementById('direccion-cliente').textContent = 'üß≠ Esperando que el cliente active GPS...';
                    return;
                }
                logDebugCliente('‚úÖ GPS del cliente ACTIVO');
                // üî• BUSCAR CON "lon" (NO "lng")
                let clienteCoords = null;
                // Opci√≥n 1: ubicacionActual (con "lon")
                if (clienteData.ubicacionActual && 
                    clienteData.ubicacionActual.lat && 
                    clienteData.ubicacionActual.lon) {
                    clienteCoords = {
                        lat: parseFloat(clienteData.ubicacionActual.lat),
                        lon: parseFloat(clienteData.ubicacionActual.lon)
                    };
                    logDebugCliente('‚úÖ Ubicaci√≥n encontrada en ubicacionActual:', clienteCoords);
                }
                // Opci√≥n 2: ubicacion (con "lon")
                else if (clienteData.ubicacion && 
                         clienteData.ubicacion.lat && 
                         clienteData.ubicacion.lon) {
                    clienteCoords = {
                        lat: parseFloat(clienteData.ubicacion.lat),
                        lon: parseFloat(clienteData.ubicacion.lon)
                    };
                    logDebugCliente('‚úÖ Ubicaci√≥n encontrada en ubicacion:', clienteCoords);
                }
                // Opci√≥n 3: campos directos
                else if (clienteData.lat && clienteData.lon) {
                    clienteCoords = {
                        lat: parseFloat(clienteData.lat),
                        lon: parseFloat(clienteData.lon)
                    };
                    logDebugCliente('‚úÖ Ubicaci√≥n encontrada en campos directos:', clienteCoords);
                }
                if (!clienteCoords) {
                    console.error('‚ùå NO SE PUDO OBTENER UBICACI√ìN DEL CLIENTE');
                    console.error('Estructura de datos recibida:', clienteData);
                    console.error('Campos buscados:');
                    console.error('  - ubicacionActual.lat/lon:', clienteData.ubicacionActual);
                    console.error('  - ubicacion.lat/lon:', clienteData.ubicacion);
                    console.error('  - lat/lon directos:', clienteData.lat, clienteData.lon);
                    document.getElementById('distancia-cliente').textContent = 'üìè No se pudo obtener ubicaci√≥n del cliente';
                    document.getElementById('direccion-cliente').textContent = 'üß≠ Verifica que el cliente tenga GPS activo';
                    return;
                }
                logDebugCliente('üéØ Coordenadas finales del cliente:', clienteCoords);
                // VALIDACI√ìN
                if (isNaN(clienteCoords.lat) || isNaN(clienteCoords.lon)) {
                    console.error('‚ùå Coordenadas inv√°lidas (NaN):', clienteCoords);
                    return;
                }
                if (clienteCoords.lat === 0 && clienteCoords.lon === 0) {
                    console.warn('‚ö†Ô∏è Coordenadas en (0, 0) - ubicaci√≥n inv√°lida');
                    document.getElementById('distancia-cliente').textContent = 'üìè Ubicaci√≥n del cliente inv√°lida';
                    return;
                }
                // Validar rango de coordenadas de Colombia
                if (clienteCoords.lat < -4.5 || clienteCoords.lat > 13.5 || 
                    clienteCoords.lon < -79.5 || clienteCoords.lon > -66.5) {
                    console.warn('‚ö†Ô∏è Coordenadas fuera del rango de Colombia:', clienteCoords);
                }
                logDebugCliente('‚úÖ Coordenadas validadas correctamente');
                logDebugCliente('üìç Agregando marcador del cliente al mapa...');
                agregarMarcadorClienteEnMapaRepartidor(clienteCoords);
            }, (error) => {
                console.error('‚ùå Error en listener del cliente:', error);
                alert(`‚ùå Error al obtener ubicaci√≥n del cliente:\n\n${error.message}`);
            });
            logDebugCliente('‚úÖ Listener de ubicaci√≥n del cliente activado');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
        } catch (error) {
            console.error('‚ùå Error al configurar listener:', error);
            alert(`‚ùå Error al iniciar seguimiento:\n\n${error.message}`);
        }
    }
    // ========================================
    // üî• ENV√çO DE UBICACI√ìN DEL REPARTIDOR (OPTIMIZADO A 15 SEGUNDOS)
    // ========================================
    function iniciarEnvioUbicacionRepartidor() {
        if (isRepartidorLocationActive) {
            logDebugRepartidor('‚ö†Ô∏è Sistema de ubicaci√≥n ya est√° activo');
            return;
        }
        if (!navigator.geolocation) {
            console.error('‚ùå Geolocalizaci√≥n no soportada');
            return;
        }
        logDebugRepartidor('Iniciando env√≠o autom√°tico de ubicaci√≥n (cada 15s)...');
        isRepartidorLocationActive = true;
        document.getElementById('gps-indicator-repartidor').classList.add('active');
        repartidorLocationWatchId = navigator.geolocation.watchPosition(
            (position) => {
                const now = Date.now();
                // üî• OPTIMIZACI√ìN: Solo enviar cada 15 segundos
                if (now - lastRepartidorLocationUpdate < REPARTIDOR_LOCATION_INTERVAL) {
                    return;
                }
                lastRepartidorLocationUpdate = now;
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                logDebugRepartidor(`üìç Ubicaci√≥n: ${lat.toFixed(6)}, ${lon.toFixed(6)} (¬±${Math.round(accuracy)}m) [15s]`);
                // Actualizar marcador en el mapa
                agregarMarcadorRepartidorEnMapa({ lat, lon });
                // Enviar a Firebase
                enviarUbicacionRepartidorAFirebase(lat, lon, accuracy);
            },
            (error) => {
                console.error('‚ùå Error GPS Repartidor:', error.message);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
        logDebugRepartidor('‚úÖ Sistema de ubicaci√≥n iniciado (cada 15s - optimizado)');
    }
    async function enviarUbicacionRepartidorAFirebase(lat, lon, accuracy) {
        if (!window.currentRepartidorUID || !db) {
            console.warn('‚ö†Ô∏è No se puede enviar ubicaci√≥n: sistema no inicializado');
            return;
        }
        try {
            const timestamp = Date.now();
            const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
            await update(ref(db, `repartidores_info/${window.currentRepartidorUID}`), {
                ubicacion: {
                    lat: parseFloat(lat.toFixed(6)),
                    lon: parseFloat(lon.toFixed(6))
                },
                ubicacionActual: {
                    lat: parseFloat(lat.toFixed(6)),
                    lon: parseFloat(lon.toFixed(6)),
                    accuracy: Math.round(accuracy),
                    timestamp: timestamp,
                    googleMapsUrl: googleMapsUrl
                },
                lastSeen: timestamp,
                gpsActivo: true
            });
            logDebugRepartidor(`‚úÖ Ubicaci√≥n ‚Üí Firebase: ${lat.toFixed(6)}, ${lon.toFixed(6)} [15s]`);
        } catch (error) {
            console.error('‚ùå Error al enviar ubicaci√≥n:', error);
        }
    }
    function detenerEnvioUbicacionRepartidor() {
        if (repartidorLocationWatchId !== null) {
            navigator.geolocation.clearWatch(repartidorLocationWatchId);
            repartidorLocationWatchId = null;
        }
        isRepartidorLocationActive = false;
        logDebugRepartidor('üõë Env√≠o de ubicaci√≥n detenido');
        document.getElementById('gps-indicator-repartidor').classList.remove('active');
        if (window.currentRepartidorUID && db) {
            update(ref(db, `repartidores_info/${window.currentRepartidorUID}`), {
                gpsActivo: false
            }).catch(err => console.error('Error al actualizar estado GPS:', err));
        }
    }
    // ========================================
    // DETENER SEGUIMIENTO
    // ========================================
    window.detenerSeguimiento = function() {
        logDebugMapa('üõë Deteniendo seguimiento...');
        if (clienteUbicacionListener && window.currentClienteID) {
            try {
                off(ref(db, `usuarios/${window.currentClienteID}`), 'value', clienteUbicacionListener);
                clienteUbicacionListener = null;
                logDebugCliente('‚úÖ Listener del cliente detenido');
            } catch (error) {
                console.warn('‚ö†Ô∏è Error al detener listener:', error);
            }
        }
        detenerEnvioUbicacionRepartidor();
        if (mapaCliente) {
            if (marcadorCliente) {
                mapaCliente.removeLayer(marcadorCliente);
                marcadorCliente = null;
            }
            if (marcadorRepartidor) {
                mapaCliente.removeLayer(marcadorRepartidor);
                marcadorRepartidor = null;
            }
        }
        document.getElementById('mapa-cliente-container').style.display = 'none';
        // üÜï LIMPIAR LOCALSTORAGE
        limpiarUbicacionClienteDeStorage();
        clienteCoordsRepartidorApp = null;
        repartidorCoords = null;
        window.currentClienteID = null;
        logDebugMapa('‚úÖ Seguimiento detenido completamente');
    }
    // ========================================
    // SISTEMA DE PERMISOS MULTIMEDIA
    // ========================================
    window.solicitarTodosLosPermisos = async function() {
        console.log('üîê Solicitando todos los permisos...');
        const modal = document.getElementById('permisosModal');
        modal.classList.remove('show');
        let todosOtorgados = true;
        // Permiso de UBICACI√ìN
        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    resolve,
                    reject,
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            });
            permisosUbicacionOtorgado = true;
            console.log('‚úÖ Permiso de UBICACI√ìN concedido');
            console.log(`üìç Ubicaci√≥n: ${position.coords.latitude}, ${position.coords.longitude}`);
        } catch (error) {
            todosOtorgados = false;
            permisosUbicacionOtorgado = false;
            console.error('‚ùå Permiso de UBICACI√ìN denegado:', error);
            alert('‚ö†Ô∏è IMPORTANTE: Permiso de ubicaci√≥n denegado.\n\n' +
                  'Sin este permiso NO podr√°s recibir pedidos.\n\n' +
                  'Para activarlo:\n' +
                  '1. Ve a Configuraci√≥n de Android\n' +
                  '2. Aplicaciones ‚Üí Servi Aliados\n' +
                  '3. Permisos ‚Üí Ubicaci√≥n\n' +
                  '4. Selecciona "Permitir TODO EL TIEMPO"');
        }
        // Permiso de C√ÅMARA
        try {
            const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoStream.getTracks().forEach(track => track.stop());
            permisosCamaraOtorgado = true;
            console.log('‚úÖ Permiso de C√ÅMARA concedido');
        } catch (error) {
            permisosCamaraOtorgado = false;
            console.warn('‚ö†Ô∏è Permiso de C√ÅMARA denegado:', error);
        }
        // Permiso de MICR√ìFONO
        try {
            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioStream.getTracks().forEach(track => track.stop());
            permisosMicrofonoOtorgado = true;
            console.log('‚úÖ Permiso de MICR√ìFONO concedido');
        } catch (error) {
            permisosMicrofonoOtorgado = false;
            console.warn('‚ö†Ô∏è Permiso de MICR√ìFONO denegado:', error);
        }
        permisosMultimediaOtorgados = todosOtorgados;
        const resumen = `
üìä RESUMEN DE PERMISOS:
${permisosUbicacionOtorgado ? '‚úÖ' : '‚ùå'} Ubicaci√≥n GPS (optimizada cada 15s)
${permisosCamaraOtorgado ? '‚úÖ' : '‚ùå'} C√°mara/Fotos
${permisosMicrofonoOtorgado ? '‚úÖ' : '‚ùå'} Micr√≥fono/Audio
${!permisosUbicacionOtorgado ? '\n‚ö†Ô∏è Sin GPS no podr√°s recibir pedidos' : ''}
${!permisosCamaraOtorgado ? '\n‚ö†Ô∏è Sin c√°mara no podr√°s enviar fotos' : ''}
${!permisosMicrofonoOtorgado ? '\n‚ö†Ô∏è Sin micr√≥fono no podr√°s enviar audios' : ''}
        `.trim();
        alert(resumen);
        if (permisosUbicacionOtorgado) {
            await iniciarTrackingGPSAutomatico();
        }
    }
    window.omitirPermisos = function() {
        console.log('‚è≠Ô∏è Permisos omitidos por el usuario');
        const modal = document.getElementById('permisosModal');
        modal.classList.remove('show');
        alert('‚ö†Ô∏è Has omitido los permisos.\n\n' +
              'Funcionalidad limitada:\n' +
              '- NO recibir√°s pedidos (sin GPS)\n' +
              '- NO podr√°s enviar fotos (sin c√°mara)\n' +
              '- NO podr√°s enviar audios (sin micr√≥fono)\n\n' +
              'Puedes activarlos despu√©s desde Configuraci√≥n.');
    }
    function mostrarModalPermisos() {
        const modal = document.getElementById('permisosModal');
        modal.classList.add('show');
    }
    // ========================================
    // SISTEMA DE HEARTBEAT SIMPLIFICADO
    // ========================================
    async function iniciarHeartbeatPrincipal() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
        }
        sessionActive = true;
        await marcarComoOnline();
        heartbeatInterval = setInterval(async () => {
            if (sessionActive && repartidorUID) {
                await marcarComoOnline();
            }
        }, 8000);
        console.log('‚úÖ Heartbeat principal iniciado (cada 8s)');
    }
    function actualizarIndicadorConexion(online) {
        const indicator = document.getElementById('connectionStatus');
        const text = document.getElementById('connectionText');
        if (online) {
            indicator.classList.remove('offline');
            indicator.classList.add('active');
            text.textContent = 'üü¢ Online';
        } else {
            indicator.classList.add('offline');
            indicator.classList.add('active');
            text.textContent = 'üî¥ Reconectando...';
        }
    }
    async function marcarComoOnline() {
        if (!repartidorUID || !db) {
            return;
        }
        try {
            const timestamp = Date.now();
            const userStatusRef = ref(db, `repartidores_info/${repartidorUID}`);
            await update(userStatusRef, {
                online: true,
                lastSeen: timestamp,
                ultimaConexion: timestamp,
                appVersion: APP_VERSION,
                navegadorActivo: !document.hidden,
                gpsActivo: isTrackingEnabled,
                backgroundMode: isBackgroundMode,
                permisosMultimedia: {
                    camara: permisosCamaraOtorgado,
                    microfono: permisosMicrofonoOtorgado,
                    ubicacion: permisosUbicacionOtorgado
                }
            });
            console.log('üíö Online:', new Date(timestamp).toLocaleTimeString());
            actualizarIndicadorConexion(true);
        } catch (error) {
            console.error('‚ùå Error al marcar como online:', error);
            actualizarIndicadorConexion(false);
        }
    }
    function detenerHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }
        sessionActive = false;
        console.log('üõë Heartbeat detenido');
    }
    async function marcarComoOffline() {
        if (!repartidorUID || !db) {
            return;
        }
        try {
            const timestamp = Date.now();
            const userStatusRef = ref(db, `repartidores_info/${repartidorUID}`);
            await update(userStatusRef, {
                online: false,
                lastSeen: timestamp,
                trackingActivo: false,
                sesionCerradaManualmente: true
            });
            console.log('üî¥ Offline marcado correctamente');
        } catch (error) {
            console.error('‚ùå Error al marcar como offline:', error);
        }
    }
    async function configurarPresenciaInicial() {
        if (!repartidorUID || !db) {
            console.warn('‚ö†Ô∏è No se puede configurar presencia sin UID');
            return;
        }
        try {
            await marcarComoOnline();
            await iniciarHeartbeatPrincipal();
            iniciarEnvioUbicacionDirecto();
            console.log('‚úÖ Sistema de presencia persistente configurado');
            actualizarIndicadorConexion(true);
        } catch (error) {
            console.error('‚ùå Error al configurar presencia:', error);
        }
    }
    // ========================================
    // üî• SISTEMA GPS OPTIMIZADO (15 SEGUNDOS)
    // ========================================
    function iniciarBackgroundGeolocation() {
        if (backgroundGeoInterval) {
            clearInterval(backgroundGeoInterval);
        }
        // üî• OPTIMIZACI√ìN: De 3s a 15s
        backgroundGeoInterval = setInterval(async () => {
            if (!repartidorUID) return;
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: 8000,
                            maximumAge: 0
                        }
                    );
                });
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const speed = position.coords.speed || 0;
                const heading = position.coords.heading || 0;
                const timestamp = Date.now();
                const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
                const userStatusRef = ref(db, `repartidores_info/${repartidorUID}`);
                await update(userStatusRef, {
                    ubicacion: {
                        lat: parseFloat(lat.toFixed(6)),
                        lon: parseFloat(lon.toFixed(6))
                    },
                    ubicacionActual: {
                        lat: parseFloat(lat.toFixed(6)),
                        lon: parseFloat(lon.toFixed(6)),
                        accuracy: Math.round(accuracy),
                        speed: Math.round(speed * 3.6),
                        heading: Math.round(heading),
                        timestamp: timestamp
                    },
                    ubicacionUrl: googleMapsUrl,
                    trackingActivo: true,
                    lastSeen: timestamp,
                    online: true,
                    backgroundMode: isBackgroundMode
                });
                console.log(`üìç BG GPS: ${lat.toFixed(6)}, ${lon.toFixed(6)} [${isBackgroundMode ? 'BACKGROUND' : 'FOREGROUND'}] [15s]`);
            } catch (error) {
                console.warn('‚ö†Ô∏è Error en background GPS:', error.message);
            }
        }, 15000); // üî• 15 SEGUNDOS (optimizado)
        console.log('‚úÖ Background Geolocation iniciado (cada 15s - optimizado)');
    }
    function detenerBackgroundGeolocation() {
        if (backgroundGeoInterval) {
            clearInterval(backgroundGeoInterval);
            backgroundGeoInterval = null;
            console.log('üõë Background Geolocation detenido');
        }
    }
    function iniciarEnvioUbicacionDirecto() {
        if (locationSendInterval) {
            clearInterval(locationSendInterval);
        }
        // üî• OPTIMIZACI√ìN: De 5s a 15s
        locationSendInterval = setInterval(async () => {
            if (isTrackingEnabled && repartidorUID && lastLocationUpdate > 0) {
                try {
                    const userStatusRef = ref(db, `repartidores_info/${repartidorUID}`);
                    await update(userStatusRef, {
                        trackingActivo: true,
                        lastSeen: Date.now(),
                        online: true
                    });
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error en env√≠o directo de ubicaci√≥n:', error);
                }
            }
        }, 15000); // üî• 15 SEGUNDOS (optimizado)
        console.log('‚úÖ Env√≠o directo de ubicaci√≥n iniciado (cada 15s - optimizado)');
    }
    async function iniciarTrackingGPSAutomatico() {
        console.log('üöÄ Iniciando GPS autom√°tico al login (optimizado)...');
        if (!permisosUbicacionOtorgado) {
            console.warn('‚ö†Ô∏è No se puede iniciar GPS sin permisos de ubicaci√≥n');
            return;
        }
        const esAPK = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone ||
                      document.referrer.includes('android-app://');
        if (esAPK) {
            console.log('üì± Detectado APK Android - Verificando permisos nativos...');
        }
        await solicitarWakeLock();
        await iniciarTrackingGPS();
        iniciarBackgroundGeolocation();
        document.getElementById('gpsIndicator').classList.add('active');
    }
    function iniciarTrackingGPS() {
        if (!navigator.geolocation) {
            console.error('‚ùå Geolocalizaci√≥n no soportada');
            return;
        }
        if (isTrackingEnabled) {
            console.log('‚ö†Ô∏è GPS ya est√° activo');
            return;
        }
        console.log('üìç Iniciando tracking GPS optimizado (15s)...');
        isTrackingEnabled = true;
        gpsErrorCount = 0;
        const esAPK = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone ||
                      document.referrer.includes('android-app://');
        const geoOptions = {
            enableHighAccuracy: true,
            timeout: esAPK ? 15000 : 10000,
            maximumAge: 0
        };
        console.log(`üì± Modo: ${esAPK ? 'APK Android' : 'Web'}`);
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const now = Date.now();
                // üî• OPTIMIZACI√ìN: Solo actualizar cada 15 segundos
                if (now - lastLocationUpdate < LOCATION_UPDATE_INTERVAL) {
                    return;
                }
                lastLocationUpdate = now;
                gpsErrorCount = 0;
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const speed = position.coords.speed || 0;
                const heading = position.coords.heading || 0;
                console.log(`üìç GPS OK [${esAPK ? 'APK' : 'Web'}]: ${lat.toFixed(6)}, ${lon.toFixed(6)} (¬±${Math.round(accuracy)}m) [15s]`);
                enviarUbicacionAFirebase(lat, lon, accuracy, speed, heading);
                enviarUbicacionDirecta(lat, lon, accuracy, speed, heading);
            },
            (error) => {
                gpsErrorCount++;
                console.error(`‚ùå Error GPS [${esAPK ? 'APK' : 'Web'}] (${gpsErrorCount}/${MAX_GPS_ERRORS}):`, error.message);
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        console.error('‚ö†Ô∏è Permiso GPS denegado');
                        if (esAPK) {
                            alert('‚ö†Ô∏è Permiso de ubicaci√≥n denegado.\n\nPara que funcione en APK:\n\n1. Configuraci√≥n ‚Üí Aplicaciones\n2. Servi Aliados ‚Üí Permisos\n3. Ubicaci√≥n ‚Üí "Permitir TODO EL TIEMPO"');
                        }
                        detenerTrackingGPS();
                        break;
                    case error.POSITION_UNAVAILABLE:
                        console.warn('üì° Se√±al GPS d√©bil, reintentando...');
                        break;
                    case error.TIMEOUT:
                        console.warn('‚è±Ô∏è Timeout GPS, reintentando...');
                        break;
                }
            },
            geoOptions
        );
        console.log('‚úÖ GPS iniciado - Actualizaci√≥n cada 15 segundos (optimizado)');
    }
    function detenerTrackingGPS() {
        if (!isTrackingEnabled) {
            return;
        }
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
        if (locationSendInterval) {
            clearInterval(locationSendInterval);
            locationSendInterval = null;
        }
        detenerBackgroundGeolocation();
        isTrackingEnabled = false;
        console.log('üõë GPS detenido');
        document.getElementById('gpsIndicator').classList.remove('active');
        if (repartidorUID) {
            update(ref(db, `repartidores_info/${repartidorUID}`), {
                trackingActivo: false,
                ultimaUbicacionTimestamp: Date.now()
            });
        }
    }
    async function enviarUbicacionAFirebase(lat, lon, accuracy, speed, heading) {
        if (!repartidorUID) return;
        try {
            const timestamp = Date.now();
            const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
            await update(ref(db, `repartidores_info/${repartidorUID}`), {
                ubicacion: {
                    lat: parseFloat(lat.toFixed(6)),
                    lon: parseFloat(lon.toFixed(6))
                },
                ubicacionActual: {
                    lat: parseFloat(lat.toFixed(6)),
                    lon: parseFloat(lon.toFixed(6)),
                    accuracy: Math.round(accuracy),
                    speed: Math.round(speed * 3.6),
                    heading: Math.round(heading),
                    timestamp: timestamp
                },
                ubicacionUrl: googleMapsUrl,
                trackingActivo: true,
                lastSeen: timestamp,
                online: true
            });
            console.log(`üìç Ubicaci√≥n Firebase SDK: ${lat.toFixed(6)}, ${lon.toFixed(6)} [15s]`);
        } catch (error) {
            console.error('‚ùå Error al enviar ubicaci√≥n Firebase SDK:', error);
        }
    }
    async function enviarUbicacionDirecta(lat, lon, accuracy, speed, heading) {
        if (!repartidorUID) return;
        try {
            const timestamp = Date.now();
            const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
            const pedidosSnapshot = await get(ref(db, 'pedidos_pendientes'));
            const pedidosData = pedidosSnapshot.val();
            if (pedidosData) {
                const promesas = [];
                Object.keys(pedidosData).forEach(pedidoId => {
                    const pedido = pedidosData[pedidoId];
                    if (pedido.repartidorUID === repartidorUID && pedido.estado !== 'Pendiente') {
                        const pedidoRef = ref(db, `pedidos_pendientes/${pedidoId}`);
                        promesas.push(
                            update(pedidoRef, {
                                ubicacionRepartidor: {
                                    lat: parseFloat(lat.toFixed(6)),
                                    lon: parseFloat(lon.toFixed(6)),
                                    accuracy: Math.round(accuracy),
                                    speed: Math.round(speed * 3.6),
                                    heading: Math.round(heading),
                                    timestamp: timestamp,
                                    googleMapsUrl: googleMapsUrl
                                }
                            })
                        );
                    }
                });
                await Promise.all(promesas);
            }
            console.log(`‚úÖ Ubicaci√≥n enviada [${new Date(timestamp).toLocaleTimeString()}] [15s]`);
        } catch (error) {
            console.error('‚ùå Error al enviar ubicaci√≥n:', error);
        }
    }
    // ========================================
    // WAKE LOCK API
    // ========================================
    async function solicitarWakeLock() {
        if (!isWakeLockSupported) {
            console.warn('‚ö†Ô∏è Wake Lock no soportado en este navegador');
            return false;
        }
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('‚úÖ Wake Lock activado - App permanecer√° activa');
            wakeLock.addEventListener('release', () => {
                console.log('‚ö†Ô∏è Wake Lock liberado');
            });
            return true;
        } catch (error) {
            console.error('‚ùå Error al solicitar Wake Lock:', error);
            return false;
        }
    }
    async function liberarWakeLock() {
        if (wakeLock !== null) {
            try {
                await wakeLock.release();
                wakeLock = null;
                console.log('üõë Wake Lock liberado');
            } catch (error) {
                console.error('‚ùå Error al liberar Wake Lock:', error);
            }
        }
    }
    // ========================================
    // MANEJO DE VISIBILIDAD DE P√ÅGINA
    // ========================================
    document.addEventListener('visibilitychange', async () => {
        if (document.hidden) {
            console.log('üì± App en segundo plano');
            isBackgroundMode = true;
            if (repartidorUID) {
                await update(ref(db, `repartidores_info/${repartidorUID}`), {
                    navegadorActivo: false,
                    backgroundMode: true
                });
            }
        } else {
            console.log('üì± App en primer plano');
            isBackgroundMode = false;
            if (repartidorUID) {
                await update(ref(db, `repartidores_info/${repartidorUID}`), {
                    navegadorActivo: true,
                    backgroundMode: false
                });
            }
            if (isWakeLockSupported && wakeLock === null) {
                await solicitarWakeLock();
            }
        }
    });
    // ========================================
    // MANEJO DE CIERRE DE APP/NAVEGADOR
    // ========================================
    window.addEventListener('beforeunload', async (event) => {
        console.log('‚ö†Ô∏è Cerrando aplicaci√≥n...');
        detenerTrackingGPS();
        detenerEnvioUbicacionRepartidor();
        detenerBackgroundGeolocation();
        detenerHeartbeat();
        await liberarWakeLock();
        if (repartidorUID) {
            try {
                await marcarComoOffline();
            } catch (error) {
                console.error('‚ùå Error al marcar offline:', error);
            }
        }
    });
    window.addEventListener('pagehide', async () => {
        console.log('üì¥ P√°gina oculta');
        if (repartidorUID) {
            try {
                await marcarComoOffline();
            } catch (error) {
                console.error('‚ùå Error al marcar offline:', error);
            }
        }
    });
    // ========================================
    // SISTEMA DE MULTIMEDIA (FOTOS/AUDIOS)
    // ========================================
    document.getElementById('sendGalleryBtn').addEventListener('click', () => {
        if (!permisosCamaraOtorgado) {
            alert('‚ö†Ô∏è No tienes permiso de c√°mara/galer√≠a.\n\nActiva el permiso en Configuraci√≥n para enviar fotos.');
            return;
        }
        document.getElementById('galleryInput').click();
    });
    document.getElementById('galleryInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ö†Ô∏è La imagen es muy grande (m√°x. 5MB)');
                return;
            }
            selectedImageFile = file;
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('previewImg').src = event.target.result;
                document.getElementById('imagePreview').classList.add('active');
            };
            reader.readAsDataURL(file);
        }
    });
    document.getElementById('cancelImageBtn').addEventListener('click', () => {
        selectedImageFile = null;
        document.getElementById('imagePreview').classList.remove('active');
        document.getElementById('galleryInput').value = '';
    });
    document.getElementById('recordAudioBtn').addEventListener('click', async () => {
        if (!permisosMicrofonoOtorgado) {
            alert('‚ö†Ô∏è No tienes permiso de micr√≥fono.\n\nActiva el permiso en Configuraci√≥n para grabar audios.');
            return;
        }
        if (isRecording) {
            console.warn('‚ö†Ô∏è Ya hay una grabaci√≥n en progreso');
            return;
        }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm;codecs=opus'
            });
            audioChunks = [];
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                selectedAudioFile = new File([audioBlob], `audio_${Date.now()}.webm`, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);
                document.getElementById('previewAudio').src = audioUrl;
                document.getElementById('audioPreview').style.display = 'block';
                stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                document.getElementById('recordingIndicator').classList.remove('active');
            };
            mediaRecorder.start();
            isRecording = true;
            document.getElementById('recordingIndicator').classList.add('active');
            let seconds = 0;
            const timerElement = document.getElementById('recordingTimer');
            const recordingTimer = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerElement.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                if (seconds >= 120) {
                    mediaRecorder.stop();
                    clearInterval(recordingTimer);
                }
            }, 1000);
            document.getElementById('stopRecordingBtn').onclick = () => {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    clearInterval(recordingTimer);
                }
            };
            console.log('üé§ Grabaci√≥n iniciada');
        } catch (error) {
            console.error('‚ùå Error al grabar audio:', error);
            alert('‚ùå No se pudo acceder al micr√≥fono.\n\nVerifica los permisos.');
            isRecording = false;
        }
    });
    document.getElementById('sendAudioFileBtn').addEventListener('click', async () => {
        if (!selectedAudioFile) {
            alert('‚ö†Ô∏è No hay audio para enviar');
            return;
        }
        try {
            document.getElementById('uploadProgress').classList.add('active');
            const audioRef = storageRef(storage, `chat_audios/${repartidorUID}_${Date.now()}.webm`);
            const uploadTask = uploadBytesResumable(audioRef, selectedAudioFile);
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('progressText').textContent = Math.round(progress) + '%';
                },
                (error) => {
                    console.error('‚ùå Error al subir audio:', error);
                    alert('‚ùå Error al enviar audio');
                    document.getElementById('uploadProgress').classList.remove('active');
                },
                async () => {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    const messageRef = push(ref(db, `chats/${repartidorUID}`));
                    await set(messageRef, {
                        tipo: 'audio',
                        audioUrl: downloadURL,
                        remitente: 'repartidor',
                        timestamp: Date.now(),
                        repartidorNombre: repartidorNombre
                    });
                    document.getElementById('uploadProgress').classList.remove('active');
                    document.getElementById('audioPreview').style.display = 'none';
                    selectedAudioFile = null;
                    console.log('‚úÖ Audio enviado correctamente');
                }
            );
        } catch (error) {
            console.error('‚ùå Error al enviar audio:', error);
            alert('‚ùå Error al enviar audio');
            document.getElementById('uploadProgress').classList.remove('active');
        }
    });
    document.getElementById('cancelAudioBtn').addEventListener('click', () => {
        selectedAudioFile = null;
        document.getElementById('audioPreview').style.display = 'none';
    });
    document.getElementById('enviarBtn').addEventListener('click', async () => {
        if (selectedImageFile) {
            await enviarImagen();
        } else {
            const mensaje = document.getElementById('mensajeInput').value.trim();
            if (mensaje) {
                await enviarMensajeTexto(mensaje);
                document.getElementById('mensajeInput').value = '';
            }
        }
    });
    document.getElementById('mensajeInput').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && !selectedImageFile) {
            const mensaje = e.target.value.trim();
            if (mensaje) {
                await enviarMensajeTexto(mensaje);
                e.target.value = '';
            }
        }
    });
    async function enviarImagen() {
        if (!selectedImageFile) return;
        try {
            document.getElementById('uploadProgress').classList.add('active');
            const imageRef = storageRef(storage, `chat_images/${repartidorUID}_${Date.now()}.jpg`);
            const uploadTask = uploadBytesResumable(imageRef, selectedImageFile);
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('progressText').textContent = Math.round(progress) + '%';
                },
                (error) => {
                    console.error('‚ùå Error al subir imagen:', error);
                    alert('‚ùå Error al enviar imagen');
                    document.getElementById('uploadProgress').classList.remove('active');
                },
                async () => {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    const messageRef = push(ref(db, `chats/${repartidorUID}`));
                    await set(messageRef, {
                        tipo: 'imagen',
                        imagenUrl: downloadURL,
                        remitente: 'repartidor',
                        timestamp: Date.now(),
                        repartidorNombre: repartidorNombre
                    });
                    document.getElementById('uploadProgress').classList.remove('active');
                    document.getElementById('imagePreview').classList.remove('active');
                    document.getElementById('galleryInput').value = '';
                    selectedImageFile = null;
                    console.log('‚úÖ Imagen enviada correctamente');
                }
            );
        } catch (error) {
            console.error('‚ùå Error al enviar imagen:', error);
            alert('‚ùå Error al enviar imagen');
            document.getElementById('uploadProgress').classList.remove('active');
        }
    }
    async function enviarMensajeTexto(mensaje) {
        try {
            const messageRef = push(ref(db, `chats/${repartidorUID}`));
            await set(messageRef, {
                mensaje: mensaje,
                remitente: 'repartidor',
                timestamp: Date.now(),
                repartidorNombre: repartidorNombre
            });
            console.log('‚úÖ Mensaje enviado:', mensaje);
        } catch (error) {
            console.error('‚ùå Error al enviar mensaje:', error);
            alert('‚ùå Error al enviar mensaje');
        }
    }
    // ========================================
    // CHAT
    // ========================================
    function escucharChat() {
        if (!repartidorUID) return;
        const chatRef = ref(db, `chats/${repartidorUID}`);
        onValue(chatRef, (snapshot) => {
            const data = snapshot.val();
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = '';
            if (!data) {
                chatBox.innerHTML = '<p style="color: #999;">No hay mensajes a√∫n...</p>';
                return;
            }
            Object.keys(data).forEach(key => {
                const msg = data[key];
                const msgDiv = document.createElement('div');
           if (msg.tipo === 'imagen' || msg.imagenUrl || msg.imageUrl || msg.urlImagen) {
    msgDiv.className = msg.remitente === 'admin' ? 'mensaje admin-msg' : 'mensaje rep-msg';
    const imageUrl = msg.imagenUrl || msg.imageUrl || msg.urlImagen || msg.url;
    msgDiv.innerHTML = `
        <img src="${imageUrl}" onclick="mostrarImagenCompleta('${imageUrl}')" style="max-width: 200px; border-radius: 8px; cursor: pointer;">
        <span class="chat-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
    `;
} else if (msg.tipo === 'audio' || msg.audioUrl || msg.urlAudio) {
    msgDiv.className = msg.remitente === 'admin' ? 'mensaje admin-msg' : 'mensaje rep-msg';
    const audioUrl = msg.audioUrl || msg.urlAudio || msg.url;
    const audioId = `audio_${key}`;
    msgDiv.innerHTML = `
        <div class="audio-message-whatsapp" style="display: flex; align-items: center; gap: 10px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 20px; max-width: 280px;">
            <button class="play-audio-btn" onclick="toggleAudio('${audioId}')" style="background: var(--color-primary); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px;">
                ‚ñ∂Ô∏è
            </button>
            <div style="flex: 1;">
                <div class="audio-wave" style="height: 30px; display: flex; align-items: center; gap: 2px;">
                    <span style="width: 3px; height: 15px; background: var(--color-primary); border-radius: 2px;"></span>
                    <span style="width: 3px; height: 22px; background: var(--color-primary); border-radius: 2px;"></span>
                    <span style="width: 3px; height: 18px; background: var(--color-primary); border-radius: 2px;"></span>
                    <span style="width: 3px; height: 25px; background: var(--color-primary); border-radius: 2px;"></span>
                    <span style="width: 3px; height: 20px; background: var(--color-primary); border-radius: 2px;"></span>
                    <span style="width: 3px; height: 15px; background: var(--color-primary); border-radius: 2px;"></span>
                    <span style="width: 3px; height: 28px; background: var(--color-primary); border-radius: 2px;"></span>
                    <span style="width: 3px; height: 17px; background: var(--color-primary); border-radius: 2px;"></span>
                </div>
                <span class="audio-duration" style="font-size: 11px; color: #999;">0:00</span>
            </div>
            <audio id="${audioId}" src="${audioUrl}" style="display: none;"></audio>
        </div>
        <span class="chat-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
    `;
                } else {
                    msgDiv.className = msg.remitente === 'admin' ? 'mensaje admin-msg' : 'mensaje rep-msg';
                    msgDiv.innerHTML = `
                        ${msg.mensaje || msg.texto || 'Sin mensaje'}
                        <span class="chat-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                    `;
                }
                chatBox.appendChild(msgDiv);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }
    window.mostrarImagenCompleta = function(url) {
        document.getElementById('modalImage').src = url;
        document.getElementById('imageModal').classList.add('active');
    }
    window.toggleAudio = function(audioId) {
    const audio = document.getElementById(audioId);
    const btn = audio.previousElementSibling.querySelector('.play-audio-btn');
    const durationSpan = audio.previousElementSibling.querySelector('.audio-duration');
    
    if (audio.paused) {
        // Pausar todos los otros audios primero
        document.querySelectorAll('audio').forEach(a => {
            if (a.id !== audioId && !a.paused) {
                a.pause();
                a.currentTime = 0;
                const otherBtn = document.querySelector(`#${a.id}`).previousElementSibling.querySelector('.play-audio-btn');
                if (otherBtn) otherBtn.innerHTML = '‚ñ∂Ô∏è';
            }
        });
        
        audio.play();
        btn.innerHTML = '‚è∏Ô∏è';
        
        audio.ontimeupdate = function() {
            const minutes = Math.floor(audio.currentTime / 60);
            const seconds = Math.floor(audio.currentTime % 60);
            durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        };
        
        audio.onended = function() {
            btn.innerHTML = '‚ñ∂Ô∏è';
            audio.currentTime = 0;
            const minutes = Math.floor(audio.duration / 60);
            const seconds = Math.floor(audio.duration % 60);
            durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        };
        
        // Mostrar duraci√≥n total al cargar
        if (audio.duration) {
            const minutes = Math.floor(audio.duration / 60);
            const seconds = Math.floor(audio.duration % 60);
            durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    } else {
        audio.pause();
        btn.innerHTML = '‚ñ∂Ô∏è';
    }
}
    // ========================================
    // PEDIDOS
    // ========================================
    function escucharPedidos() {
        if (!repartidorUID) return;
        const pedidosRef = ref(db, 'pedidos_pendientes');
        onValue(pedidosRef, (snapshot) => {
            const data = snapshot.val();
            const listaPendientes = document.getElementById('pedidosList');
            const listaAsignados = document.getElementById('pedidosAsignadosList');
            let contadorPendientes = 0;
            let contadorAsignados = 0;
            listaPendientes.innerHTML = '';
            listaAsignados.innerHTML = '';
            if (!data) {
                listaPendientes.innerHTML = '<p style="color: #999;">No hay pedidos pendientes.</p>';
                listaAsignados.innerHTML = '<p style="color: #999;">No tienes pedidos asignados.</p>';
                document.getElementById('pendientesBadge').style.display = 'none';
                document.getElementById('asignadosCount').textContent = '0';
                return;
            }
            Object.keys(data).forEach(pedidoId => {
                const pedido = data[pedidoId];
                if (pedido.estado === 'Pendiente') {
                    contadorPendientes++;
                    mostrarPedidoPendiente(pedido, pedidoId, listaPendientes);
                    if (!initialLoad && !pedidosActivos[pedidoId]) {
                        reproducirNotificacion();
                    }
                    pedidosActivos[pedidoId] = true;
                } else if (pedido.repartidorUID === repartidorUID && 
                          (pedido.estado === 'Aceptado' || pedido.estado === 'Esperando' || pedido.estado === 'En Camino')) {
                    contadorAsignados++;
                    mostrarPedidoAsignado(pedido, pedidoId, listaAsignados);
                    // üÜï GUARDAR DATOS DEL PEDIDO ACTIVO PARA PERSISTENCIA
                    if (!activePedidoData || activePedidoData.pedidoId !== pedidoId) {
                        activePedidoData = {
                            pedidoId: pedidoId,
                            clienteUID: pedido.clienteUID,
                            estado: pedido.estado
                        };
                    }
                }
            });
            if (contadorPendientes === 0) {
                listaPendientes.innerHTML = '<p style="color: #999;">No hay pedidos pendientes.</p>';
                document.getElementById('pendientesBadge').style.display = 'none';
            } else {
                document.getElementById('pendientesBadge').style.display = 'inline-block';
                document.getElementById('pendientesBadge').textContent = contadorPendientes;
            }
            if (contadorAsignados === 0) {
                listaAsignados.innerHTML = '<p style="color: #999;">No tienes pedidos asignados.</p>';
                activePedidoData = null; // üÜï LIMPIAR DATOS DEL PEDIDO ACTIVO
            }
            document.getElementById('asignadosCount').textContent = contadorAsignados;
            initialLoad = false;
        });
    }
    function mostrarPedidoPendiente(pedido, pedidoId, container) {
        const div = document.createElement('div');
        div.className = 'pedido-item';
        div.innerHTML = `
     <strong>Pedido #${pedidoId.slice(-6)}</strong><br>
        üì¶ ${pedido.items || pedido.producto || pedido.descripcion || pedido.detalle || 'Sin producto'}<br>
        üíµ ${pedido.total || pedido.precio || pedido.valor || pedido.costo || 'Sin precio'}<br>
        üìç ${pedido.direccionEntrega || pedido.direccion || pedido.ubicacion || pedido.destino || 'Sin direcci√≥n'}<br>
        üë§ ${pedido.nombreCliente || pedido.nombre || pedido.cliente || pedido.receptor || 'Sin nombre'}<br>
        üìû ${pedido.telefonoCliente || pedido.telefono || pedido.celular || pedido.contacto || 'Sin tel√©fono'}<br>
        üìù ${pedido.observaciones || pedido.detalles || pedido.notas || pedido.comentarios || 'Sin detalles'}<br>
        <button onclick="window.aceptarPedido('${pedidoId}')" 
                style="background: var(--color-primary); color: var(--color-background); margin-top: 10px;">
            ‚úÖ Aceptar Pedido
        </button>
    `;
        container.appendChild(div);
    }
    function mostrarPedidoAsignado(pedido, pedidoId, container) {
        const div = document.createElement('div');
        div.className = 'pedido-item asignado';
        if (pedido.estado === 'Esperando') {
            div.classList.add('esperando');
        } else if (pedido.estado === 'En Camino') {
            div.classList.add('en-camino');
        }
        let estadoBotones = '';
        if (pedido.estado === 'Aceptado') {
            estadoBotones = `
                <button onclick="window.cambiarEstadoPedido('${pedidoId}', 'Esperando')" 
                        style="background: var(--color-waiting); color: white;">
                    ‚è≥ Marcar como Esperando
                </button>
            `;
        } else if (pedido.estado === 'Esperando') {
            estadoBotones = `
                <button onclick="window.cambiarEstadoPedido('${pedidoId}', 'En Camino')" 
                        style="background: var(--color-delivery); color: white;">
                    üöö Marcar En Camino
                </button>
            `;
        } else if (pedido.estado === 'En Camino') {
            estadoBotones = `
                <button onclick="window.completarPedido('${pedidoId}')" 
                        style="background: #27ae60; color: white;">
                    ‚úÖ Completar Pedido
                </button>
            `;
        }
        const tiempoTranscurrido = pedido.tiempoAceptado ? calcularTiempoTranscurrido(pedido.tiempoAceptado) : '00:00';
        div.innerHTML = `
    <strong>üöö Pedido #${pedidoId.slice(-6)}</strong><br>
    üè∑Ô∏è Estado: <strong style="color: var(--color-primary);">${pedido.estado || 'Desconocido'}</strong><br>
    ${pedido.estado !== 'Aceptado' ? `<span class="timer">‚è±Ô∏è ${tiempoTranscurrido}</span>` : ''}
    <hr style="border-color: #444; margin: 10px 0;">
    üì¶ ${pedido.items || pedido.producto || pedido.descripcion || 'Sin producto'}<br>
    üíµ ${pedido.total || pedido.precio || pedido.valor || 'Sin precio'}<br>
    üìç ${pedido.direccionEntrega || pedido.direccion || pedido.ubicacion || 'Sin direcci√≥n'}<br>
    üë§ ${pedido.nombreCliente || pedido.nombre || pedido.cliente || 'Sin nombre'}<br>
    üìû ${pedido.telefonoCliente || pedido.telefono || pedido.celular || 'Sin tel√©fono'}<br>
    üìù ${pedido.observaciones || pedido.detalles || pedido.notas || 'Sin detalles'}<br>
            ${estadoBotones}
            <button onclick="window.iniciarCancelacion('${pedidoId}')" 
                    style="background: var(--color-accent-danger); color: white;">
                ‚ùå Cancelar Domicilio
            </button>
        `;
        container.appendChild(div);
    }
    function calcularTiempoTranscurrido(timestamp) {
        const ahora = Date.now();
        const diferencia = ahora - timestamp;
        const minutos = Math.floor(diferencia / 60000);
        const segundos = Math.floor((diferencia % 60000) / 1000);
        return `${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
    }
    window.aceptarPedido = async function(pedidoId) {
        try {
            const pedidoRef = ref(db, `pedidos_pendientes/${pedidoId}`);
            const snapshot = await get(pedidoRef);
            if (!snapshot.exists()) {
                alert('‚ùå El pedido ya no existe');
                return;
            }
            const pedido = snapshot.val();
            await update(pedidoRef, {
                estado: 'Aceptado',
                repartidorUID: repartidorUID,
                repartidorNombre: repartidorNombre,
                tiempoAceptado: Date.now()
            });
            console.log('‚úÖ Pedido aceptado:', pedidoId);
            alert('‚úÖ Pedido aceptado correctamente');
            // üÜï INICIAR SEGUIMIENTO DEL CLIENTE INMEDIATAMENTE
            if (pedido.clienteUID) {
                setTimeout(() => {
                    document.getElementById('showAsignadosBtn').click();
                    iniciarSeguimientoCliente(pedido.clienteUID);
                    document.getElementById('mapa-cliente-container').style.display = 'block';
                }, 500);
            }
        } catch (error) {
            console.error('‚ùå Error al aceptar pedido:', error);
            alert('‚ùå Error al aceptar el pedido');
        }
    }
    window.cambiarEstadoPedido = async function(pedidoId, nuevoEstado) {
        try {
            const pedidoRef = ref(db, `pedidos_pendientes/${pedidoId}`);
            await update(pedidoRef, {
                estado: nuevoEstado,
                [`tiempo${nuevoEstado.replace(' ', '')}`]: Date.now()
            });
            console.log(`‚úÖ Estado cambiado a: ${nuevoEstado}`);
        } catch (error) {
            console.error('‚ùå Error al cambiar estado:', error);
            alert('‚ùå Error al cambiar el estado del pedido');
        }
    }
    window.completarPedido = async function(pedidoId) {
        const confirmacion = confirm('¬øConfirmar que el pedido ha sido completado?');
        if (!confirmacion) return;
        try {
            const pedidoRef = ref(db, `pedidos_pendientes/${pedidoId}`);
            const snapshot = await get(pedidoRef);
            if (!snapshot.exists()) {
                alert('‚ùå El pedido no existe');
                return;
            }
            const pedido = snapshot.val();
            await set(ref(db, `pedidos_historial/${pedidoId}`), {
                ...pedido,
                estado: 'Completado',
                tiempoCompletado: Date.now()
            });
            await remove(pedidoRef);
            window.detenerSeguimiento(); // üÜï DETENER SEGUIMIENTO AL COMPLETAR
            console.log('‚úÖ Pedido completado:', pedidoId);
            alert('‚úÖ Pedido completado y movido al historial');
        } catch (error) {
            console.error('‚ùå Error al completar pedido:', error);
            alert('‚ùå Error al completar el pedido');
        }
    }
    window.iniciarCancelacion = function(pedidoId) {
        currentPedidoIdToCancel = pedidoId;
        document.getElementById('cancelModal').style.display = 'flex';
    }
    window.ejecutarCancelacionConMotivo = async function(motivo) {
        if (!currentPedidoIdToCancel) return;
        try {
            const pedidoRef = ref(db, `pedidos_pendientes/${currentPedidoIdToCancel}`);
            const snapshot = await get(pedidoRef);
            if (!snapshot.exists()) {
                alert('‚ùå El pedido no existe');
                document.getElementById('cancelModal').style.display = 'none';
                return;
            }
            const pedido = snapshot.val();
            await set(ref(db, `pedidos_historial/${currentPedidoIdToCancel}`), {
                ...pedido,
                estado: 'Cancelado',
                motivoCancelacion: motivo,
                canceladoPor: 'Repartidor',
                tiempoCancelado: Date.now()
            });
            await remove(pedidoRef);
            window.detenerSeguimiento(); // üÜï DETENER SEGUIMIENTO AL CANCELAR
            document.getElementById('cancelModal').style.display = 'none';
            currentPedidoIdToCancel = null;
            console.log('‚úÖ Pedido cancelado con motivo:', motivo);
            alert(`‚úÖ Pedido cancelado\n\nMotivo: ${motivo}`);
        } catch (error) {
            console.error('‚ùå Error al cancelar pedido:', error);
            alert('‚ùå Error al cancelar el pedido');
        }
    }
    function escucharHistorial() {
        if (!repartidorUID) return;
        const historialRef = ref(db, 'pedidos_historial');
        onValue(historialRef, (snapshot) => {
            const data = snapshot.val();
            const listaHistorial = document.getElementById('pedidosHistorialList');
            listaHistorial.innerHTML = '';
            if (!data) {
                listaHistorial.innerHTML = '<p style="color: #999;">No hay pedidos en el historial.</p>';
                return;
            }
            const pedidosArray = Object.entries(data)
                .filter(([_, pedido]) => pedido.repartidorUID === repartidorUID)
                .sort((a, b) => (b[1].tiempoCompletado || b[1].tiempoCancelado || 0) - (a[1].tiempoCompletado || a[1].tiempoCancelado || 0));
            if (pedidosArray.length === 0) {
                listaHistorial.innerHTML = '<p style="color: #999;">No tienes pedidos en el historial.</p>';
                return;
            }
            pedidosArray.forEach(([pedidoId, pedido]) => {
                const div = document.createElement('div');
                div.className = 'pedido-item';
                div.style.borderLeft = pedido.estado === 'Completado' ? '5px solid #27ae60' : '5px solid #C0392B';
                const fecha = pedido.tiempoCompletado || pedido.tiempoCancelado;
                const fechaTexto = fecha ? new Date(fecha).toLocaleString() : 'N/A';
                div.innerHTML = `
    <strong>${pedido.estado === 'Completado' ? '‚úÖ' : '‚ùå'} Pedido #${pedidoId.slice(-6)}</strong><br>
    üè∑Ô∏è Estado: <strong>${pedido.estado || 'Desconocido'}</strong><br>
    ${pedido.motivoCancelacion ? `üìù Motivo: ${pedido.motivoCancelacion}<br>` : ''}
    üìÖ Fecha: ${fechaTexto}<br>
    <hr style="border-color: #444; margin: 10px 0;">
    üì¶ ${pedido.items || pedido.producto || pedido.descripcion || pedido.detalle || 'Sin producto'}<br>
    üíµ ${pedido.total || pedido.precio || pedido.valor || pedido.costo || 'Sin precio'}<br>
    üìç ${pedido.direccionEntrega || pedido.direccion || pedido.ubicacion || pedido.destino || 'Sin direcci√≥n'}<br>
    üë§ ${pedido.nombreCliente || pedido.nombre || pedido.cliente || pedido.receptor || 'Sin nombre'}<br>
    üìû ${pedido.telefonoCliente || pedido.telefono || pedido.celular || pedido.contacto || 'Sin tel√©fono'}
`;
                listaHistorial.appendChild(div);
            });
        });
    }
    function reproducirNotificacion() {
        const audio = document.getElementById('notificationSound');
        audio.play().catch(err => console.warn('No se pudo reproducir notificaci√≥n:', err));
    }
    // ========================================
    // NAVEGACI√ìN
    // ========================================
    document.getElementById('showChatBtn').addEventListener('click', () => {
        document.getElementById('chatSection').style.display = 'block';
        document.getElementById('pendientesSection').style.display = 'none';
        document.getElementById('asignadosSection').style.display = 'none';
        document.getElementById('historialSection').style.display = 'none';
        window.detenerSeguimiento(); // üÜï DETENER AL CAMBIAR DE SECCI√ìN
    });
    document.getElementById('showPendientesBtn').addEventListener('click', () => {
        document.getElementById('chatSection').style.display = 'none';
        document.getElementById('pendientesSection').style.display = 'block';
        document.getElementById('asignadosSection').style.display = 'none';
        document.getElementById('historialSection').style.display = 'none';
        window.detenerSeguimiento(); // üÜï DETENER AL CAMBIAR DE SECCI√ìN
    });
    document.getElementById('showAsignadosBtn').addEventListener('click', () => {
        document.getElementById('chatSection').style.display = 'none';
        document.getElementById('pendientesSection').style.display = 'none';
        document.getElementById('asignadosSection').style.display = 'block';
        document.getElementById('historialSection').style.display = 'none';
        // üÜï RESTAURAR SEGUIMIENTO SI HAY PEDIDO ACTIVO
        if (activePedidoData && activePedidoData.clienteUID) {
            setTimeout(() => {
                iniciarSeguimientoCliente(activePedidoData.clienteUID);
                document.getElementById('mapa-cliente-container').style.display = 'block';
            }, 300);
        }
    });
    document.getElementById('showHistorialBtn').addEventListener('click', () => {
        document.getElementById('chatSection').style.display = 'none';
        document.getElementById('pendientesSection').style.display = 'none';
        document.getElementById('asignadosSection').style.display = 'none';
        document.getElementById('historialSection').style.display = 'block';
        window.detenerSeguimiento(); // üÜï DETENER AL CAMBIAR DE SECCI√ìN
    });
    document.getElementById('verMapaBtn').addEventListener('click', () => {
        document.getElementById('showAsignadosBtn').click();
        setTimeout(() => {
            const mapaContainer = document.getElementById('mapa-cliente-container');
            if (mapaContainer.style.display === 'none') {
                mapaContainer.style.display = 'block';
                inicializarMapaCliente();
                // üÜï RESTAURAR SEGUIMIENTO
                if (activePedidoData && activePedidoData.clienteUID) {
                    iniciarSeguimientoCliente(activePedidoData.clienteUID);
                }
            }
        }, 100);
    });
    // ========================================
    // AUTENTICACI√ìN
    // ========================================
    document.getElementById('registerBtn').addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) {
            document.getElementById('loginError').textContent = 'Por favor completa todos los campos';
            return;
        }
        if (password.length < 6) {
            document.getElementById('loginError').textContent = 'La contrase√±a debe tener al menos 6 caracteres';
            return;
        }
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const uid = userCredential.user.uid;
            localStorage.setItem('lastRepartidorEmail', email);
            localStorage.setItem('lastRepartidorPassword', password);
            console.log('‚úÖ Usuario registrado:', uid);
        } catch (error) {
            console.error('‚ùå Error al registrar:', error);
            if (error.code === 'auth/email-already-in-use') {
                document.getElementById('loginError').textContent = 'Este correo ya est√° registrado. Usa "Iniciar Sesi√≥n".';
            } else if (error.code === 'auth/invalid-email') {
                document.getElementById('loginError').textContent = 'Correo electr√≥nico inv√°lido';
            } else if (error.code === 'auth/weak-password') {
                document.getElementById('loginError').textContent = 'La contrase√±a es muy d√©bil';
            } else {
                document.getElementById('loginError').textContent = 'Error: ' + error.message;
            }
        }
    });
    document.getElementById('loginBtn').addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) {
            document.getElementById('loginError').textContent = 'Por favor completa todos los campos';
            return;
        }
        try {
            await signInWithEmailAndPassword(auth, email, password);
            localStorage.setItem('lastRepartidorEmail', email);
            localStorage.setItem('lastRepartidorPassword', password);
            console.log('‚úÖ Inicio de sesi√≥n exitoso');
        } catch (error) {
            console.error('‚ùå Error al iniciar sesi√≥n:', error);
            if (error.code === 'auth/user-not-found') {
                document.getElementById('loginError').textContent = 'Usuario no encontrado. Reg√≠strate primero.';
            } else if (error.code === 'auth/wrong-password') {
                document.getElementById('loginError').textContent = 'Contrase√±a incorrecta';
            } else if (error.code === 'auth/invalid-email') {
                document.getElementById('loginError').textContent = 'Correo electr√≥nico inv√°lido';
            } else {
                document.getElementById('loginError').textContent = 'Error: ' + error.message;
            }
        }
    });
    document.getElementById('completeRegBtn').addEventListener('click', async () => {
        const nombre = document.getElementById('regName').value.trim();
        const telefono = document.getElementById('regPhone').value.trim();
        const telefonoSecundario = document.getElementById('regSecondaryPhone').value.trim();
        const direccion = document.getElementById('regAddress').value.trim();
        if (!nombre || !telefono || !direccion) {
            alert('‚ùå Por favor completa todos los campos obligatorios (*)');
            return;
        }
        try {
            await set(ref(db, `repartidores_info/${repartidorUID}`), {
                nombre: nombre,
                telefono: telefono,
                telefonoSecundario: telefonoSecundario || '',
                direccion: direccion,
                email: auth.currentUser.email,
                uid: repartidorUID,
                fechaRegistro: Date.now(),
                online: false,
                trackingActivo: false,
                appVersion: APP_VERSION
            });
            repartidorNombre = nombre;
            window.currentRepartidorNombre = nombre;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('repartidorName').textContent = nombre;
            await configurarPresenciaInicial();
            escucharChat();
            escucharPedidos();
            escucharHistorial();
            mostrarModalPermisos();
            console.log('‚úÖ Registro completado');
        } catch (error) {
            console.error('‚ùå Error al completar registro:', error);
            alert('‚ùå Error al guardar informaci√≥n: ' + error.message);
        }
    });
    document.getElementById('regLogoutBtn').addEventListener('click', async () => {
        try {
            await signOut(auth);
            console.log('‚úÖ Sesi√≥n cerrada');
        } catch (error) {
            console.error('‚ùå Error al cerrar sesi√≥n:', error);
        }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        const confirmacion = confirm('¬øSeguro que deseas cerrar sesi√≥n?');
        if (!confirmacion) return;
        try {
            await marcarComoOffline();
            detenerTrackingGPS();
            detenerEnvioUbicacionRepartidor();
            detenerBackgroundGeolocation();
            detenerHeartbeat();
            await liberarWakeLock();
            await signOut(auth);
            console.log('‚úÖ Sesi√≥n cerrada correctamente');
        } catch (error) {
            console.error('‚ùå Error al cerrar sesi√≥n:', error);
        }
    });
    const lastEmail = localStorage.getItem('lastRepartidorEmail');
    const lastPassword = localStorage.getItem('lastRepartidorPassword');
    if (lastEmail && lastPassword) {
        document.getElementById('quickLoginArea').style.display = 'block';
        document.getElementById('quickLoginMessage').textContent = `√öltima sesi√≥n: ${lastEmail}`;
        document.getElementById('quickLoginBtn').addEventListener('click', async () => {
            try {
                await signInWithEmailAndPassword(auth, lastEmail, lastPassword);
                console.log('‚úÖ Inicio de sesi√≥n r√°pido exitoso');
            } catch (error) {
                console.error('‚ùå Error en inicio r√°pido:', error);
                alert('‚ùå Error al iniciar sesi√≥n r√°pida. Ingresa manualmente.');
            }
        });
    }
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            repartidorUID = user.uid;
            window.currentRepartidorUID = user.uid;
            console.log('üë§ Usuario autenticado:', user.uid);
            const repRef = ref(db, `repartidores_info/${user.uid}`);
            const snapshot = await get(repRef);
            if (snapshot.exists()) {
                const data = snapshot.val();
                repartidorNombre = data.nombre || 'Repartidor';
                window.currentRepartidorNombre = repartidorNombre;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('repartidorName').textContent = repartidorNombre;
                await configurarPresenciaInicial();
                escucharChat();
                escucharPedidos();
                escucharHistorial();
                mostrarModalPermisos();
                console.log('‚úÖ App iniciada correctamente');
            } else {
                document.getElementById('manualLoginForm').style.display = 'none';
                document.getElementById('registrationForm').style.display = 'block';
                document.getElementById('regEmailDisplay').value = user.email;
            }
        } else {
            repartidorUID = null;
            window.currentRepartidorUID = null;
            window.currentRepartidorNombre = null;
            detenerTrackingGPS();
            detenerEnvioUbicacionRepartidor();
            detenerBackgroundGeolocation();
            detenerHeartbeat();
            await liberarWakeLock();
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('manualLoginForm').style.display = 'block';
            document.getElementById('registrationForm').style.display = 'none';
            console.log('üë§ Usuario no autenticado');
        }
    });
</script>
</body>
</html>
