<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Permissions-Policy" content="camera=*, microphone=*, geolocation=*">
    <meta http-equiv="Feature-Policy" content="camera *; microphone *; geolocation *">
    
    <!-- Configuraci√≥n para APK Android -->
    <meta name="theme-color" content="#FFC300">
    <meta name="mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <!-- Leaflet CSS para Mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Service Worker para operaciones en segundo plano -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('‚úÖ Service Worker registrado'))
                .catch(err => console.error('‚ùå Error SW:', err));
        }
    </script>
    
    <!-- Eruda - Herramienta de depuraci√≥n para m√≥viles -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        eruda.init();
        console.log('‚úÖ Eruda inicializado correctamente');
    </script>
    
    <title>Panel Repartidor - Servi Aliados</title>
    <style>
        /* Paleta de Colores de Servi Aliados */
        :root {
            --color-primary: #FFC300;
            --color-secondary: #D7D7D7;
            --color-background: #111111;
            --color-accent-danger: #C0392B;
            --color-waiting: #E67E22;
            --color-delivery: #2980B9;
            --color-card: #222222;
        }

        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--color-background);
            color: var(--color-secondary);
        }
        
        #loginContainer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--color-background);
            z-index: 2000; display: flex; 
            justify-content: center; align-items: center; flex-direction: column;
        }
        #loginContainer > div {
            background: #222222;
            padding: 30px; border-radius: 10px; 
            box-shadow: 0 0 20px rgba(255,195,0,0.3);
            width: 90%; max-width: 350px;
        }
        #loginContainer input {
            background: #333;
            color: white;
            border: 1px solid #444;
            width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; box-sizing: border-box;
        }
        
        #loginContainer button {
            width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 10px; border-radius: 4px; box-sizing: border-box;
            background: var(--color-primary);
            color: var(--color-background);
            border: none; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s;
        }
        #loginContainer button:hover {
            background: #e6b200;
        }
        #loginContainer button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #registrationForm h3, #registrationForm p {
            color: var(--color-primary);
            text-align: center;
        }
        #registrationForm label {
            font-size: 0.9em; display: block; margin-top: 10px; margin-bottom: 5px;
            color: var(--color-secondary);
        }
        
        #quickLoginArea {
            margin-top: 15px; 
            border-top: 1px solid #444; 
            padding-top: 10px; 
            text-align: center;
        }

        #appContainer { display: none; max-width: 900px; margin: 20px auto; padding: 20px; }
        
        h2, h3 { color: var(--color-secondary); }

        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px;
            margin: 20px 0;
        }
        .nav-buttons button {
            padding: 10px 5px; 
            border: none; 
            color: var(--color-background);
            border-radius: 5px; 
            font-weight: bold;
            position: relative;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .nav-buttons button:hover {
            opacity: 0.9;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--color-accent-danger);
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 0.7em;
            line-height: 1;
            display: none; 
        }

        .pedidos-list {
            background: #222222;
            padding: 15px; border-radius: 10px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); 
            margin-top: 20px;
        }
        .pedido-item {
            padding: 10px; border-bottom: 1px solid #333; margin-bottom: 10px;
            background: #333333; 
            border-left: 5px solid var(--color-accent-danger);
            color: var(--color-secondary);
            position: relative; 
            border-radius: 4px;
        }
        .pedido-item.asignado { border-left: 5px solid var(--color-primary); background: #444444; }
        .pedido-item.esperando { border-left: 5px solid var(--color-waiting); }
        .pedido-item.en-camino { border-left: 5px solid var(--color-delivery); }

        .pedido-item strong { color: var(--color-primary); }
        .pedido-item button { 
            border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-top: 5px; 
            font-weight: bold;
            transition: opacity 0.2s;
        }
        .pedido-item button:hover {
            opacity: 0.8;
        }
        .pedido-item .timer {
            font-size: 1.2em; font-weight: bold; color: var(--color-primary);
            margin-top: 5px; display: block;
        }

        /* üÜï ESTILOS DEL MAPA */
        #mapa-cliente-container {
            margin-top: 20px;
            background: var(--color-card);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        #mapa-cliente {
            width: 100%;
            height: 400px;
            margin: 15px 0;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--color-primary);
        }

        .map-legend {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 8px;
        }

        .map-legend > div {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .map-info-box {
            background: var(--color-card);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

        .map-info-box strong {
            color: var(--color-primary);
            display: block;
            margin-bottom: 5px;
        }

        .map-info-box p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        #cancelModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000;
            display: none; justify-content: center; align-items: center;
        }
        #cancelModalContent {
            background: #222222; 
            color: var(--color-secondary);
            padding: 20px; border-radius: 8px; width: 90%; max-width: 300px; text-align: center;
        }
        #cancelModalContent button {
            background: var(--color-accent-danger); 
            margin-top: 10px; margin-bottom: 5px;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        #cancelModalContent button:hover {
            opacity: 0.8;
        }

        /* Estilos del Chat Mejorados */
        .chat-box {
             background: #222222; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); margin-top: 20px;
        }
        .mensajes-area { 
            max-height: 400px; 
            overflow-y: auto; 
            padding: 10px; 
            border: 1px solid #444; 
            border-radius: 5px; 
            background: #1a1a1a;
        }
        .mensaje { 
            padding: 8px 12px; 
            border-radius: 12px; 
            margin: 5px 0; 
            max-width: 80%; 
            word-wrap: break-word;
            clear: both;
        }
        .admin-msg { 
            background-color: var(--color-primary);
            color: var(--color-background); 
            float: left;
            margin-right: auto; 
        }
        .rep-msg { 
            background-color: #555555;
            color: white; 
            float: right;
            margin-left: auto; 
        }
        .chat-time { 
            font-size: 10px; 
            margin-top: 3px; 
            display: block; 
            text-align: right; 
            color: rgba(0, 0, 0, 0.7); 
        }
        .rep-msg .chat-time { 
            color: rgba(255, 255, 255, 0.7); 
        }
        /* Estilos para multimedia en chat */
        .mensaje img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 5px;
            display: block;
            cursor: pointer;
        }
        .mensaje audio {
            width: 100%;
            max-width: 250px;
            margin-top: 5px;
            display: block;
        }

        /* Controles de multimedia */
        .media-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .media-controls button {
            background: #444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        .media-controls button:hover {
            background: #555;
        }
        .media-controls button.active {
            background: var(--color-accent-danger);
        }
        .media-controls input[type="file"] {
            display: none;
        }

        /* Indicador de grabaci√≥n */
        .recording-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--color-accent-danger);
            color: white;
            border-radius: 5px;
            margin-top: 10px;
        }
        .recording-indicator.active {
            display: flex;
        }
        .recording-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Vista previa de imagen */
        .image-preview {
            display: none;
            margin-top: 10px;
            position: relative;
        }
        .image-preview.active {
            display: block;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 5px;
        }
        .image-preview button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--color-accent-danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        /* Modal para ver imagen completa */
        #imageModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        #imageModal.active {
            display: flex;
        }
        #imageModal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        #imageModal button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--color-accent-danger);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
        }

        /* Indicador de carga */
        .upload-progress {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #333;
            border-radius: 5px;
            text-align: center;
        }
        .upload-progress.active {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #444;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            width: 0%;
            transition: width 0.3s;
        }

        /* Indicador GPS Activo */
        .gps-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.5);
            animation: pulse-gps 2s infinite;
        }

        .gps-indicator.active {
            display: flex;
        }

        @keyframes pulse-gps {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .gps-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* üÜï Indicador GPS del Repartidor */
        .gps-indicator-repartidor {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #2196F3;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.85em;
            font-weight: bold;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);
            animation: pulse-gps 2s infinite;
        }

        .gps-indicator-repartidor.active {
            display: flex;
        }

        /* ESTILOS DEL SISTEMA DE ACTUALIZACIONES */
        #updateModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        #updateModal.show {
            display: flex;
        }

        .update-content {
            background: linear-gradient(135deg, #FFC300 0%, #e6b200 100%);
            padding: 40px 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(255, 195, 0, 0.5);
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .update-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulseUpdate 2s infinite;
        }

        @keyframes pulseUpdate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .update-content h2 {
            color: #111;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .update-content p {
            color: #333;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .version-info {
            background: rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .version-info p {
            margin: 5px 0;
            font-weight: bold;
        }

        .version-old {
            color: #C0392B;
        }

        .version-new {
            color: #27ae60;
        }

        .changelog {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .changelog h3 {
            color: #111;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .changelog ul {
            margin: 0;
            padding-left: 20px;
        }

        .changelog li {
            color: #333;
            margin: 5px 0;
        }

        .update-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .update-buttons button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-update {
            background: #27ae60;
            color: white;
        }

        .btn-update:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-later {
            background: #555;
            color: white;
        }

        .btn-later:hover {
            background: #666;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 195, 0, 0.3);
            border-top: 5px solid #FFC300;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #FFC300;
            font-size: 1.2em;
            font-weight: bold;
        }

        .version-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #C0392B;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 1000;
            cursor: pointer;
            animation: shake 2s infinite;
            display: none;
        }

        .version-badge.show {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Indicador de conexi√≥n persistente */
        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .connection-status.active {
            display: flex;
        }

        .connection-status.offline {
            background: #C0392B;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        /* üÜï MODAL DE PERMISOS MULTIMEDIA */
        #permisosModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 15000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #permisosModal.show {
            display: flex;
        }

        .permisos-content {
            background: #222;
            padding: 30px;
            border-radius: 15px;
            max-width: 450px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(255, 195, 0, 0.3);
        }

        .permisos-content h2 {
            color: var(--color-primary);
            margin-bottom: 20px;
        }

        .permisos-content p {
            color: var(--color-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .permisos-list {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            background: #333;
            border-radius: 10px;
        }

        .permiso-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 10px;
            background: #444;
            border-radius: 8px;
        }

        .permiso-icon {
            font-size: 32px;
            width: 50px;
            text-align: center;
        }

        .permiso-info {
            flex: 1;
        }

        .permiso-info strong {
            color: var(--color-primary);
            display: block;
            margin-bottom: 5px;
        }

        .permiso-info small {
            color: #999;
            font-size: 0.85em;
        }

        .permisos-warning {
            background: rgba(230, 126, 34, 0.2);
            border: 1px solid #E67E22;
            color: #E67E22;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.9em;
        }

        .permisos-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .permisos-buttons button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-permitir {
            background: var(--color-primary);
            color: var(--color-background);
        }

        .btn-permitir:hover {
            background: #e6b200;
            transform: translateY(-2px);
        }

        .btn-omitir {
            background: #555;
            color: white;
        }

        .btn-omitir:hover {
            background: #666;
        }
    </style>
</head>
<body>

<!-- INDICADOR DE CONEXI√ìN -->
<div id="connectionStatus" class="connection-status">
    <div class="status-dot"></div>
    <span id="connectionText">üü¢ Online</span>
</div>

<!-- INDICADOR GPS ACTIVO -->
<div id="gpsIndicator" class="gps-indicator">
    <div class="gps-dot"></div>
    <span>üìç GPS Activo</span>
</div>

<!-- üÜï INDICADOR GPS DEL REPARTIDOR -->
<div id="gps-indicator-repartidor" class="gps-indicator-repartidor">
    <div class="gps-dot"></div>
    <span>üèçÔ∏è GPS Activo</span>
</div>

<!-- üÜï MODAL DE PERMISOS MULTIMEDIA -->
<div id="permisosModal">
    <div class="permisos-content">
        <h2>üîê Permisos Necesarios</h2>
        <p>Para usar todas las funciones necesitamos acceso a:</p>
        
        <div class="permisos-list">
            <div class="permiso-item">
                <div class="permiso-icon">üìç</div>
                <div class="permiso-info">
                    <strong>Ubicaci√≥n GPS</strong>
                    <small>Tracking continuo cada 2-3 segundos</small>
                </div>
            </div>
            
            <div class="permiso-item">
                <div class="permiso-icon">üì∑</div>
                <div class="permiso-info">
                    <strong>C√°mara/Galer√≠a</strong>
                    <small>Para enviar fotos en el chat</small>
                </div>
            </div>
            
            <div class="permiso-item">
                <div class="permiso-icon">üé§</div>
                <div class="permiso-info">
                    <strong>Micr√≥fono</strong>
                    <small>Para grabar y enviar audios</small>
                </div>
            </div>
        </div>
        
        <div class="permisos-warning">
            ‚ö†Ô∏è <strong>Importante:</strong> El GPS se activar√° autom√°ticamente y continuar√° activo incluso si minimizas la app.
        </div>
        
        <div class="permisos-buttons">
            <button class="btn-permitir" onclick="solicitarTodosLosPermisos()">
                ‚úÖ Permitir Todo
            </button>
            <button class="btn-omitir" onclick="omitirPermisos()">
                ‚è≠Ô∏è Continuar sin permisos
            </button>
        </div>
    </div>
</div>
<!-- MODAL DE ACTUALIZACI√ìN -->
<div id="updateModal">
    <div class="update-content">
        <div class="update-icon">üöÄ</div>
        <h2>¬°Nueva Actualizaci√≥n Disponible!</h2>
        <p>Hay una nueva versi√≥n de la aplicaci√≥n con mejoras y correcciones.</p>
        
        <div class="version-info">
            <p>Versi√≥n actual: <span class="version-old" id="currentVersion">1.0.0</span></p>
            <p>Nueva versi√≥n: <span class="version-new" id="newVersion">1.0.0</span></p>
        </div>
        
        <div class="changelog">
            <h3>üìã Novedades:</h3>
            <ul id="changelogList">
                <li>Cargando...</li>
            </ul>
        </div>
        
        <div class="update-buttons">
            <button class="btn-update" onclick="actualizarApp()">
                üîÑ Actualizar Ahora
            </button>
            <button class="btn-later" onclick="recordarMasTarde()">
                ‚è∞ M√°s Tarde
            </button>
        </div>
        
        <p style="font-size: 0.85em; margin-top: 15px; color: #666;">
            üí° Se recomienda actualizar para obtener las √∫ltimas mejoras
        </p>
    </div>
</div>

<!-- INDICADOR DE CARGA DE ACTUALIZACI√ìN -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p class="loading-text">Actualizando aplicaci√≥n...</p>
</div>

<!-- BADGE DE NOTIFICACI√ìN DE VERSI√ìN -->
<div id="versionBadge" class="version-badge" onclick="mostrarModalActualizacion()">
    üîî Nueva versi√≥n disponible
</div>

<!-- CONTENEDOR DE LOGIN -->
<div id="loginContainer">
    <div id="manualLoginForm">
        <h3 style="text-align: center; color: var(--color-primary);">Bienvenido</h3>
        <p style="text-align: center; font-size: 0.9em; margin-bottom: 20px;">
            Inicia sesi√≥n o reg√≠strate con tu correo y contrase√±a:
        </p>
        
        <label style="font-size: 0.8em; display: block; margin-bottom: 5px; color: var(--color-secondary);">Correo Electr√≥nico:</label>
        <input type="email" id="loginEmail" placeholder="tu.correo@ejemplo.com">
        
        <label style="font-size: 0.8em; display: block; margin-bottom: 5px; color: var(--color-secondary);">Contrase√±a:</label>
        <input type="password" id="loginPassword" placeholder="Contrase√±a (M√≠n. 6 caracteres)">
        
        <button id="registerBtn">
            Registrarse (Crear Cuenta)
        </button>
        <button id="loginBtn" style="background: var(--color-primary); color: var(--color-background);">
            Iniciar Sesi√≥n
        </button>
        
        <p id="loginError" style="color: var(--color-accent-danger); margin-top: 10px; text-align: center;"></p>
        
        <div id="quickLoginArea" style="display: none;">
            <p id="quickLoginMessage" style="margin-bottom: 5px; font-size: 0.9em; color: var(--color-primary);"></p>
            <button id="quickLoginBtn" style="background: var(--color-primary); color: var(--color-background); border: none;">Entrar R√°pido (Un Clic)</button>
        </div>
    </div>
    <div id="registrationForm" style="display:none;">
        <h3 style="color: var(--color-primary);">Completa tu Registro</h3>
        <p style="font-size: 0.9em; margin-bottom: 15px;">
            Falta informaci√≥n esencial para solicitar domicilios.
        </p>
        
        <label>Nombre completo: *</label>
        <input type="text" id="regName" placeholder="Tu Nombre Completo">
        
        <label>Correo Electr√≥nico:</label>
        <input type="email" id="regEmailDisplay" placeholder="Email (no editable)" disabled style="color: #999;">
        
        <label>Tel√©fono principal: *</label>
        <input type="text" id="regPhone" placeholder="Tu N√∫mero de Tel√©fono (√önico)">

        <label>Tel√©fono secundario (opcional):</label>
        <input type="text" id="regSecondaryPhone" placeholder="Otro N√∫mero de Contacto">
        
        <label>Direcci√≥n de residencia: *</label>
        <input type="text" id="regAddress" placeholder="Direcci√≥n de tu Residencia">
        
        <button id="completeRegBtn" style="background: var(--color-primary); color: var(--color-background); margin-top: 20px;">Guardar y Continuar</button>
        <button id="regLogoutBtn" style="background: #555555; color: white;">Cerrar Sesi√≥n</button>
    </div>
</div>

<!-- CONTENEDOR DE LA APLICACI√ìN -->
<div id="appContainer">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
        <h2 style="color: var(--color-secondary); margin: 0;">Bienvenido, <span id="repartidorName"></span>!</h2>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <span id="appVersionDisplay" style="background: #27ae60; color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: bold;">
                v1.7.0
            </span>
            <button id="verMapaBtn" style="padding: 8px 15px; background: #2196F3; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                üó∫Ô∏è Ver Mapa Cliente
            </button>
            <button id="logoutBtn" style="padding: 8px 15px; background: var(--color-accent-danger); color: white; border: none; border-radius: 5px; font-weight: bold;">
                Cerrar Sesi√≥n
            </button>
        </div>
    </div>

    <div class="nav-buttons">
        <button id="showChatBtn" style="background: var(--color-primary);">üí¨ Chat</button>
        <button id="showPendientesBtn" style="background: var(--color-accent-danger);">
            üì¶ Pendientes <span id="pendientesBadge" class="notification-badge">!</span>
        </button>
        <button id="showAsignadosBtn" style="background: var(--color-primary);">üöö Asignados (<span id="asignadosCount">0</span>)</button>
        <button id="showHistorialBtn" style="background: var(--color-secondary); color: var(--color-background);">üìú Historial</button>
    </div>
    
    <div id="chatSection">
        <h3 style="color: var(--color-secondary);">üí¨ Chat con Administrador</h3>
        <div class="chat-box">
            <div class="mensajes-area" id="chatBox">Esperando mensaje del Admin...</div>
            
            <!-- Controles multimedia -->
            <div class="media-controls">
                <button id="sendGalleryBtn" title="Seleccionar foto de galer√≠a">üñºÔ∏è Galer√≠a</button>
                <button id="recordAudioBtn" title="Grabar audio">üé§ Grabar Audio</button>
                <input type="file" id="galleryInput" accept="image/*" style="display: none;">
            </div>

            <!-- Vista previa de audio -->
            <div class="audio-preview" id="audioPreview" style="display: none; margin-top: 10px; padding: 10px; background: #333; border-radius: 5px;">
                <p style="color: #FFC300; margin: 0 0 5px 0;">üé§ Audio grabado:</p>
                <audio id="previewAudio" controls style="width: 100%; max-width: 300px;"></audio>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="sendAudioFileBtn" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; flex: 1;">‚úÖ Enviar Audio</button>
                    <button id="cancelAudioBtn" style="background: var(--color-accent-danger); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">‚úï Cancelar</button>
                </div>
            </div>
            
            <!-- Indicador de grabaci√≥n -->
            <div class="recording-indicator" id="recordingIndicator">
                <div class="recording-dot"></div>
                <span id="recordingTimer">00:00</span>
                <button id="stopRecordingBtn" style="background: var(--color-accent-danger); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Detener</button>
            </div>
            
            <!-- Vista previa de imagen -->
            <div class="image-preview" id="imagePreview">
                <img id="previewImg" src="" alt="Preview">
                <button id="cancelImageBtn">‚úï</button>
            </div>
            
            <!-- Indicador de progreso de carga -->
            <div class="upload-progress" id="uploadProgress">
                <p>Subiendo archivo...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">0%</p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" id="mensajeInput" placeholder="Escribe un mensaje..." style="flex-grow: 1; background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 5px;">
                <button id="enviarBtn" style="background: var(--color-primary); color: var(--color-background); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Enviar</button>
            </div>
        </div>
    </div>

    <div id="pendientesSection" style="display:none;">
        <h3 style="color: var(--color-secondary);">üì¶ Nuevos Pedidos (Pendientes)</h3>
        <div class="pedidos-list" id="pedidosList">Cargando pedidos pendientes...</div>
    </div>
    
    <div id="asignadosSection" style="display:none;">
        <h3 style="color: var(--color-secondary);">üöö Mis Pedidos Asignados</h3>
        
        <!-- üÜï MAPA DEL CLIENTE -->
        <div id="mapa-cliente-container" style="display: none;">
            <h4 style="color: var(--color-primary); margin-top: 20px;">üó∫Ô∏è Ubicaci√≥n del Cliente</h4>
            
            <div id="mapa-cliente"></div>
            
            <div class="map-legend">
                <div>
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #4CAF50;"></div>
                    <span>üìç Cliente</span>
                </div>
                <div>
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #2196F3;"></div>
                    <span>üèçÔ∏è T√∫</span>
                </div>
            </div>
            
            <div class="map-info-box">
                <strong>üìä Informaci√≥n de Navegaci√≥n</strong>
                <p id="distancia-cliente">üìè Calculando distancia...</p>
                <p id="direccion-cliente">üß≠ Calculando direcci√≥n...</p>
            </div>
        </div>
        
        <div class="pedidos-list" id="pedidosAsignadosList">No tienes pedidos asignados actualmente.</div>
    </div>

    <div id="historialSection" style="display:none;">
        <h3 style="color: var(--color-secondary);">üìú Historial de Domicilios Completados/Cancelados</h3>
        <div class="pedidos-list" id="pedidosHistorialList">Cargando historial...</div>
    </div>
</div>

<!-- MODAL DE CANCELACI√ìN -->
<div id="cancelModal">
    <div id="cancelModalContent">
        <h4>¬øPor qu√© deseas cancelar este domicilio?</h4>
        <div id="motivosContainer">
            <button onclick="window.ejecutarCancelacionConMotivo('Env√≠o/Domicilio mal tomado')" style="background: var(--color-accent-danger); width: 100%;">Env√≠o/Domicilio mal tomado</button>
            <button onclick="window.ejecutarCancelacionConMotivo('Me var√© (Problemas con el veh√≠culo)')" style="background: var(--color-accent-danger); width: 100%;">Me var√© (Problemas con el veh√≠culo)</button>
            <button onclick="window.ejecutarCancelacionConMotivo('Fin de turno/No puedo cubrirlo')" style="background: var(--color-accent-danger); width: 100%;">Fin de turno/No puedo cubrirlo</button>
            <button onclick="window.ejecutarCancelacionConMotivo('Correcci√≥n de datos / Contacto fallido')" style="background: var(--color-accent-danger); width: 100%;">Correcci√≥n de datos / Contacto fallido</button>
        </div>
        <button onclick="document.getElementById('cancelModal').style.display='none';" style="background: #555555; width: 100%; margin-top: 15px; color: white;">Cerrar</button>
    </div>
</div>

<!-- Modal para ver imagen completa -->
<div id="imageModal">
    <button onclick="document.getElementById('imageModal').classList.remove('active');">‚úï Cerrar</button>
    <img id="modalImage" src="" alt="Imagen completa">
</div>

<audio id="notificationSound" src="https://github.com/dt9650329-ops/Chat-administrador-/raw/f67a159f93aed6be1d6f7f02709384111cd84b7e/%E2%9C%A8Monedas%20Cayendo%20__%20Efectos%20De%20Sonidos(MP3_160K).mp3" preload="auto"></audio>

<!-- Leaflet JS para Mapas -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, update, get, remove, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ‚öôÔ∏è Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAZX7Q5B29Xti4YtV9wXuiREVdkgcclv9U",
      authDomain: "domicilios-1cd74.firebaseapp.com",
      databaseURL: "https://domicilios-1cd74-default-rtdb.firebaseio.com",
      projectId: "domicilios-1cd74",
      storageBucket: "domicilios-1cd74.firebasestorage.app",
      messagingSenderId: "771819437001",
      appId: "1:771819437001:web:xxxxxxxxxxxxxx"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // üÜï Exportar al scope global
    window.db = db;
    window.ref = ref;
    window.update = update;
    window.get = get;
    window.onValue = onValue;
    window.off = off;

    // VERSI√ìN ACTUALIZADA CON DEBUGGING MEJORADO
    const APP_VERSION = "1.7.0";
    
    window.addEventListener('DOMContentLoaded', () => {
        const versionDisplay = document.getElementById('appVersionDisplay');
        if (versionDisplay) {
            versionDisplay.textContent = `v${APP_VERSION}`;
        }
    });

    // VARIABLES GLOBALES
    let repartidorUID = null;
    let repartidorNombre = "Repartidor";
    let timerInterval = null; 
    let currentPedidoIdToCancel = null; 
    let initialLoad = true;
    
    // Variables globales para seguimiento
    window.currentRepartidorUID = null;
    window.currentRepartidorNombre = null;
    window.currentClienteID = null;
    
    // Variables para grabaci√≥n de audio
    let selectedImageFile = null;
    let selectedAudioFile = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = 0;
    let recordingTimerInterval = null;
    
    // Variables de tracking GPS
    let watchId = null;
    let lastLocationUpdate = 0;
    const LOCATION_UPDATE_INTERVAL = 2000;
    let isTrackingEnabled = false;
    let pedidosActivos = {};
    let gpsErrorCount = 0;
    const MAX_GPS_ERRORS = 3;

    // Variables para presencia persistente
    let heartbeatInterval = null;
    let sessionActive = false;

    // Variables para Wake Lock
    let wakeLock = null;
    let isWakeLockSupported = 'wakeLock' in navigator;

    // Variables para env√≠o de ubicaci√≥n
    let locationSendInterval = null;
    
    // Variables para Background Geolocation
    let backgroundGeoInterval = null;
    let isBackgroundMode = false;

    // Variables para permisos multimedia
    let permisosMultimediaOtorgados = false;
    let permisosCamaraOtorgado = false;
    let permisosMicrofonoOtorgado = false;
    let permisosUbicacionOtorgado = false;

    // ========================================
    // üÜï SISTEMA DE SEGUIMIENTO DEL CLIENTE
    // ========================================
    
    let mapaCliente = null;
    let marcadorCliente = null;
    let marcadorRepartidor = null;
    let clienteUbicacionListener = null;
    let repartidorCoords = null;
    let clienteCoordsRepartidorApp = null;
    let repartidorLocationWatchId = null;
    let isRepartidorLocationActive = false;
    let lastRepartidorLocationUpdate = 0;
    const REPARTIDOR_LOCATION_INTERVAL = 5000;

    // ========================================
    // üÜï FUNCIONES DE DEBUGGING MEJORADAS
    // ========================================

    function logDebugCliente(mensaje, datos = null) {
        console.log(`üîç [CLIENTE] ${mensaje}`, datos || '');
    }

    function logDebugRepartidor(mensaje, datos = null) {
        console.log(`üèçÔ∏è [REPARTIDOR] ${mensaje}`, datos || '');
    }

    function logDebugMapa(mensaje, datos = null) {
        console.log(`üó∫Ô∏è [MAPA] ${mensaje}`, datos || '');
    }

    // ========================================
    // üÜï INICIALIZAR MAPA DEL CLIENTE (MEJORADO)
    // ========================================

    function inicializarMapaCliente() {
        logDebugMapa('Inicializando mapa del cliente...');
        
        if (mapaCliente) {
            logDebugMapa('Removiendo mapa existente');
            mapaCliente.remove();
            mapaCliente = null;
        }

        // Coordenadas por defecto (Bogot√°)
        const defaultCoords = [4.710989, -74.072092];
        
        mapaCliente = L.map('mapa-cliente').setView(defaultCoords, 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(mapaCliente);

        setTimeout(() => {
            if (mapaCliente) {
                mapaCliente.invalidateSize();
                logDebugMapa('Tama√±o del mapa actualizado');
            }
        }, 100);
        
        logDebugMapa('‚úÖ Mapa del cliente inicializado correctamente');
    }

    // ========================================
    // üÜï AGREGAR MARCADORES (MEJORADO CON DEBUG)
    // ========================================

    function agregarMarcadorClienteEnMapaRepartidor(coords) {
    logDebugCliente('Intentando agregar marcador del cliente', coords);
    
    // üî• VALIDACI√ìN: Verificar que coords tenga "lon" (no "lng")
    if (!coords || !coords.lat || !coords.lon) {
        console.error('‚ùå Coordenadas del cliente inv√°lidas:', coords);
        return;
    }
    
    clienteCoordsRepartidorApp = coords;
    
    if (marcadorCliente) {
        logDebugCliente('Actualizando marcador existente');
        // ‚úÖ USAR "lon" en lugar de "lng"
        marcadorCliente.setLatLng([coords.lat, coords.lon]);
    } else {
        logDebugCliente('Creando nuevo marcador del cliente');
        
        const iconCliente = L.divIcon({
            className: 'custom-marker-cliente',
            html: '<div style="background-color: #4CAF50; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        try {
            // ‚úÖ USAR "lon" en lugar de "lng"
            marcadorCliente = L.marker([coords.lat, coords.lon], { icon: iconCliente })
                .addTo(mapaCliente)
                .bindPopup('<b>üìç Cliente</b>');
            
            // ‚úÖ USAR "lon" en lugar de "lng"
            mapaCliente.setView([coords.lat, coords.lon], 15);
            logDebugCliente('‚úÖ Marcador del cliente agregado al mapa');
        } catch (error) {
            console.error('‚ùå Error al agregar marcador del cliente al mapa:', error);
        }
    }
    
    if (repartidorCoords) {
        calcularDistanciaYDireccion();
    }
}

    function agregarMarcadorRepartidorEnMapa(coords) {
        logDebugRepartidor('Intentando agregar marcador del repartidor', coords);
        
        if (!coords || !coords.lat || !coords.lng) {
            console.error('‚ùå Coordenadas del repartidor inv√°lidas:', coords);
            return;
        }
        
        repartidorCoords = coords;
        
        if (marcadorRepartidor) {
            logDebugRepartidor('Actualizando marcador existente');
            marcadorRepartidor.setLatLng([coords.lat, coords.lng]);
        } else {
            logDebugRepartidor('Creando nuevo marcador del repartidor');
            
            const iconRepartidor = L.divIcon({
                className: 'custom-marker-repartidor',
                html: '<div style="background-color: #2196F3; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            try {
                marcadorRepartidor = L.marker([coords.lat, coords.lng], { icon: iconRepartidor })
                    .addTo(mapaCliente)
                    .bindPopup('<b>üèçÔ∏è T√∫</b>');
                
                logDebugRepartidor('‚úÖ Marcador del repartidor agregado al mapa');
            } catch (error) {
                console.error('‚ùå Error al agregar marcador del repartidor al mapa:', error);
            }
        }
        
        // Calcular distancia si tenemos ambas ubicaciones
        if (clienteCoordsRepartidorApp) {
            calcularDistanciaYDireccion();
        }
    }

    // ========================================
    // CALCULAR DISTANCIA Y DIRECCI√ìN
    // ========================================

    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c;
    }

    function calcularDireccion(lat1, lon1, lat2, lon2) {
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

        const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
        const x = Math.cos(œÜ1) * Math.sin(œÜ2) - Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
        const Œ∏ = Math.atan2(y, x);
        const bearing = (Œ∏ * 180 / Math.PI + 360) % 360;

        const directions = ['Norte ‚¨ÜÔ∏è', 'Noreste ‚ÜóÔ∏è', 'Este ‚û°Ô∏è', 'Sureste ‚ÜòÔ∏è', 'Sur ‚¨áÔ∏è', 'Suroeste ‚ÜôÔ∏è', 'Oeste ‚¨ÖÔ∏è', 'Noroeste ‚ÜñÔ∏è'];
        const index = Math.round(bearing / 45) % 8;
        
        return directions[index];
    }

    function calcularDistanciaYDireccion() {
    if (!clienteCoordsRepartidorApp || !repartidorCoords) {
        logDebugMapa('‚ö†Ô∏è No se pueden calcular distancia/direcci√≥n: faltan coordenadas');
        return;
    }
    
    // ‚úÖ USAR "lon" consistentemente
    const distancia = calcularDistancia(
        repartidorCoords.lat, repartidorCoords.lon,
        clienteCoordsRepartidorApp.lat, clienteCoordsRepartidorApp.lon
    );
    
    const direccion = calcularDireccion(
        repartidorCoords.lat, repartidorCoords.lon,
        clienteCoordsRepartidorApp.lat, clienteCoordsRepartidorApp.lon
    );
    
    const distanciaKm = (distancia / 1000).toFixed(2);
    const tiempoEstimado = Math.round(distancia / (30000 / 60));
    
    document.getElementById('distancia-cliente').textContent = 
        `üìè Distancia: ${distanciaKm} km (${tiempoEstimado} min aprox.)`;
    document.getElementById('direccion-cliente').textContent = 
        `üß≠ Direcci√≥n: ${direccion}`;
    
    logDebugMapa(`üìä Distancia: ${distanciaKm} km, Direcci√≥n: ${direccion}`);
}

    // ========================================
    // üÜï INICIAR SEGUIMIENTO DEL CLIENTE (MEJORADO)
    // ========================================

    function iniciarSeguimientoCliente(clienteID) {
    console.log('');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üëÅÔ∏è INICIANDO SEGUIMIENTO DEL CLIENTE');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    logDebugCliente(`Cliente ID: ${clienteID}`);
    
    if (!clienteID) {
        console.error('‚ùå ERROR CR√çTICO: clienteID es null o undefined');
        alert('‚ö†Ô∏è Error: No se pudo obtener el ID del cliente. El mapa no mostrar√° su ubicaci√≥n.');
        return;
    }
    
    window.currentClienteID = clienteID;
    
    if (clienteUbicacionListener) {
        try {
            off(ref(db, `users/${clienteID}`), 'value', clienteUbicacionListener);
            logDebugCliente('üõë Listener anterior detenido');
        } catch (error) {
            console.warn('‚ö†Ô∏è Error al detener listener anterior:', error);
        }
    }
    
    const clienteRef = ref(db, `users/${clienteID}`);
    logDebugCliente(`Configurando listener en: users/${clienteID}`);
    
    try {
        clienteUbicacionListener = onValue(clienteRef, (snapshot) => {
            logDebugCliente('üì° Snapshot recibido del cliente');
            
            if (!snapshot.exists()) {
                console.warn('‚ö†Ô∏è Datos del cliente no disponibles en Firebase');
                document.getElementById('distancia-cliente').textContent = 'üìè Cliente no encontrado en la base de datos';
                return;
            }
            
            const clienteData = snapshot.val();
            logDebugCliente('üìä Datos completos del cliente:', clienteData);
            
            if (!clienteData.gpsActivo) {
                console.warn('‚ö†Ô∏è GPS del cliente no est√° activo');
                document.getElementById('distancia-cliente').textContent = 'üìè GPS del cliente desactivado';
                document.getElementById('direccion-cliente').textContent = 'üß≠ Esperando que el cliente active GPS...';
                return;
            }
            
            logDebugCliente('‚úÖ GPS del cliente ACTIVO');
            
            // üî• CORRECCI√ìN: Usar "lon" en lugar de "lng"
            let clienteCoords = null;
            
            if (clienteData.ubicacionActual && 
                clienteData.ubicacionActual.lat && 
                clienteData.ubicacionActual.lon) {
                
                clienteCoords = {
                    lat: clienteData.ubicacionActual.lat,
                    lon: clienteData.ubicacionActual.lon  // ‚úÖ USAR "lon"
                };
                logDebugCliente('‚úÖ Ubicaci√≥n encontrada en ubicacionActual:', clienteCoords);
            }
            else if (clienteData.ubicacion && 
                     clienteData.ubicacion.lat && 
                     clienteData.ubicacion.lon) {
                
                clienteCoords = {
                    lat: clienteData.ubicacion.lat,
                    lon: clienteData.ubicacion.lon  // ‚úÖ USAR "lon"
                };
                logDebugCliente('‚úÖ Ubicaci√≥n encontrada en ubicacion:', clienteCoords);
            }
            else if (clienteData.lat && clienteData.lon) {
                clienteCoords = {
                    lat: clienteData.lat,
                    lon: clienteData.lon  // ‚úÖ USAR "lon"
                };
                logDebugCliente('‚úÖ Ubicaci√≥n encontrada en campos directos:', clienteCoords);
            }
            
            if (!clienteCoords) {
                console.error('‚ùå NO SE PUDO OBTENER UBICACI√ìN DEL CLIENTE');
                console.error('Estructura de datos recibida:', clienteData);
                document.getElementById('distancia-cliente').textContent = 'üìè No se pudo obtener ubicaci√≥n del cliente';
                document.getElementById('direccion-cliente').textContent = 'üß≠ Verifica que el cliente tenga GPS activo';
                return;
            }
            
            logDebugCliente('üéØ Coordenadas finales del cliente:', clienteCoords);
            
            if (isNaN(clienteCoords.lat) || isNaN(clienteCoords.lon)) {
                console.error('‚ùå Coordenadas inv√°lidas (NaN):', clienteCoords);
                return;
            }
            
            logDebugCliente('üìç Llamando a agregarMarcadorClienteEnMapaRepartidor...');
            agregarMarcadorClienteEnMapaRepartidor(clienteCoords);
            
        }, (error) => {
            console.error('‚ùå Error en listener del cliente:', error);
            alert(`‚ùå Error al obtener ubicaci√≥n del cliente:\n\n${error.message}`);
        });
        
        logDebugCliente('‚úÖ Listener de ubicaci√≥n del cliente activado');
    } catch (error) {
        console.error('‚ùå Error al configurar listener:', error);
        alert(`‚ùå Error al iniciar seguimiento:\n\n${error.message}`);
    }
    
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('');
}

    // ========================================
    // ENVIAR UBICACI√ìN DEL REPARTIDOR A FIREBASE
    // ========================================

    function iniciarEnvioUbicacionRepartidor() {
        if (isRepartidorLocationActive) {
            logDebugRepartidor('‚ö†Ô∏è Sistema de ubicaci√≥n ya est√° activo');
            return;
        }
        
        if (!navigator.geolocation) {
            console.error('‚ùå Geolocalizaci√≥n no soportada');
            return;
        }
        
        logDebugRepartidor('Iniciando env√≠o autom√°tico de ubicaci√≥n...');
        isRepartidorLocationActive = true;
        
        document.getElementById('gps-indicator-repartidor').classList.add('active');
        
        repartidorLocationWatchId = navigator.geolocation.watchPosition(
            (position) => {
                const now = Date.now();
                
                if (now - lastRepartidorLocationUpdate < REPARTIDOR_LOCATION_INTERVAL) {
                    return;
                }
                
                lastRepartidorLocationUpdate = now;
                
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                logDebugRepartidor(`üìç Ubicaci√≥n: ${lat.toFixed(6)}, ${lng.toFixed(6)} (¬±${Math.round(accuracy)}m)`);
                
                // Actualizar marcador en el mapa
                agregarMarcadorRepartidorEnMapa({ lat, lng });
                
                // Enviar a Firebase
                enviarUbicacionRepartidorAFirebase(lat, lng, accuracy);
            },
            (error) => {
                console.error('‚ùå Error GPS Repartidor:', error.message);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
        
        logDebugRepartidor('‚úÖ Sistema de ubicaci√≥n iniciado (cada 5s)');
    }

    async function enviarUbicacionRepartidorAFirebase(lat, lng, accuracy) {
        if (!window.currentRepartidorUID || !db) {
            console.warn('‚ö†Ô∏è No se puede enviar ubicaci√≥n: sistema no inicializado');
            return;
        }
        
        try {
            const timestamp = Date.now();
            const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            
            await update(ref(db, `repartidores_info/${window.currentRepartidorUID}`), {
                ubicacion: {
                    lat: parseFloat(lat.toFixed(6)),
                    lon: parseFloat(lng.toFixed(6))
                },
                ubicacionActual: {
                    lat: parseFloat(lat.toFixed(6)),
                    lon: parseFloat(lng.toFixed(6)),
                    accuracy: Math.round(accuracy),
                    timestamp: timestamp,
                    googleMapsUrl: googleMapsUrl
                },
                lastSeen: timestamp,
                gpsActivo: true
            });
            
            logDebugRepartidor(`‚úÖ Ubicaci√≥n ‚Üí Firebase: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            
        } catch (error) {
            console.error('‚ùå Error al enviar ubicaci√≥n:', error);
        }
    }

    function detenerEnvioUbicacionRepartidor() {
        if (repartidorLocationWatchId !== null) {
            navigator.geolocation.clearWatch(repartidorLocationWatchId);
            repartidorLocationWatchId = null;
        }
        
        isRepartidorLocationActive = false;
        logDebugRepartidor('üõë Env√≠o de ubicaci√≥n detenido');
        
        document.getElementById('gps-indicator-repartidor').classList.remove('active');
        
        if (window.currentRepartidorUID && db) {
            update(ref(db, `repartidores_info/${window.currentRepartidorUID}`), {
                gpsActivo: false
            }).catch(err => console.error('Error al actualizar estado GPS:', err));
        }
    }

    // ========================================
    // DETENER SEGUIMIENTO
    // ========================================

    window.detenerSeguimiento = function() {
        logDebugMapa('üõë Deteniendo seguimiento...');
        
        // Detener listener del cliente
        if (clienteUbicacionListener && window.currentClienteID) {
            try {
                off(ref(db, `users/${window.currentClienteID}`), 'value', clienteUbicacionListener);
                clienteUbicacionListener = null;
                logDebugCliente('‚úÖ Listener del cliente detenido');
            } catch (error) {
                console.warn('‚ö†Ô∏è Error al detener listener:', error);
            }
        }
        
        // Detener GPS del repartidor
        detenerEnvioUbicacionRepartidor();
        
        // Limpiar mapa
        if (mapaCliente) {
            if (marcadorCliente) {
                mapaCliente.removeLayer(marcadorCliente);
                marcadorCliente = null;
            }
            if (marcadorRepartidor) {
                mapaCliente.removeLayer(marcadorRepartidor);
                marcadorRepartidor = null;
            }
        }
        
        // Ocultar contenedor del mapa
        document.getElementById('mapa-cliente-container').style.display = 'none';
        
        clienteCoordsRepartidorApp = null;
        repartidorCoords = null;
        window.currentClienteID = null;
        
        logDebugMapa('‚úÖ Seguimiento detenido completamente');
    }

    // ========================================
    // SISTEMA DE PERMISOS MULTIMEDIA
    // ========================================
    
    window.solicitarTodosLosPermisos = async function() {
        console.log('üîê Solicitando todos los permisos...');
        
        const modal = document.getElementById('permisosModal');
        modal.classList.remove('show');
        
        let todosOtorgados = true;
        
        // 1Ô∏è‚É£ Solicitar permiso de UBICACI√ìN (GPS)
        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    resolve,
                    reject,
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            });
            
            permisosUbicacionOtorgado = true;
            console.log('‚úÖ Permiso de UBICACI√ìN concedido');
            console.log(`üìç Ubicaci√≥n: ${position.coords.latitude}, ${position.coords.longitude}`);
            
        } catch (error) {
            todosOtorgados = false;
            permisosUbicacionOtorgado = false;
            console.error('‚ùå Permiso de UBICACI√ìN denegado:', error);
            
            alert('‚ö†Ô∏è IMPORTANTE: Permiso de ubicaci√≥n denegado.\n\n' +
                  'Sin este permiso NO podr√°s recibir pedidos.\n\n' +
                  'Para activarlo:\n' +
                  '1. Ve a Configuraci√≥n de Android\n' +
                  '2. Aplicaciones ‚Üí Servi Aliados\n' +
                  '3. Permisos ‚Üí Ubicaci√≥n\n' +
                  '4. Selecciona "Permitir TODO EL TIEMPO"');
        }
        
        // 2Ô∏è‚É£ Solicitar permiso de C√ÅMARA
        try {
            const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoStream.getTracks().forEach(track => track.stop());
            permisosCamaraOtorgado = true;
            console.log('‚úÖ Permiso de C√ÅMARA concedido');
            
        } catch (error) {
            permisosCamaraOtorgado = false;
            console.warn('‚ö†Ô∏è Permiso de C√ÅMARA denegado:', error);
        }
        
        // 3Ô∏è‚É£ Solicitar permiso de MICR√ìFONO
        try {
            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioStream.getTracks().forEach(track => track.stop());
            permisosMicrofonoOtorgado = true;
            console.log('‚úÖ Permiso de MICR√ìFONO concedido');
            
        } catch (error) {
            permisosMicrofonoOtorgado = false;
            console.warn('‚ö†Ô∏è Permiso de MICR√ìFONO denegado:', error);
        }
        
        permisosMultimediaOtorgados = todosOtorgados;
        
        // Mostrar resumen
        const resumen = `
üìä RESUMEN DE PERMISOS:

${permisosUbicacionOtorgado ? '‚úÖ' : '‚ùå'} Ubicaci√≥n GPS
${permisosCamaraOtorgado ? '‚úÖ' : '‚ùå'} C√°mara/Fotos
${permisosMicrofonoOtorgado ? '‚úÖ' : '‚ùå'} Micr√≥fono/Audio

${!permisosUbicacionOtorgado ? '\n‚ö†Ô∏è Sin GPS no podr√°s recibir pedidos' : ''}
${!permisosCamaraOtorgado ? '\n‚ö†Ô∏è Sin c√°mara no podr√°s enviar fotos' : ''}
${!permisosMicrofonoOtorgado ? '\n‚ö†Ô∏è Sin micr√≥fono no podr√°s enviar audios' : ''}
        `.trim();
        
        alert(resumen);
        
        // Iniciar GPS si fue otorgado
        if (permisosUbicacionOtorgado) {
            await iniciarTrackingGPSAutomatico();
        }
    }
    
    window.omitirPermisos = function() {
        console.log('‚è≠Ô∏è Permisos omitidos por el usuario');
        
        const modal = document.getElementById('permisosModal');
        modal.classList.remove('show');
        
        alert('‚ö†Ô∏è Has omitido los permisos.\n\n' +
              'Funcionalidad limitada:\n' +
              '- NO recibir√°s pedidos (sin GPS)\n' +
              '- NO podr√°s enviar fotos (sin c√°mara)\n' +
              '- NO podr√°s enviar audios (sin micr√≥fono)\n\n' +
              'Puedes activarlos despu√©s desde Configuraci√≥n.');
    }
    
    function mostrarModalPermisos() {
        const modal = document.getElementById('permisosModal');
        modal.classList.add('show');
    }

    // ========================================
    // SISTEMA DE HEARTBEAT SIMPLIFICADO
    // ========================================
    
    async function iniciarHeartbeatPrincipal() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
        }

        sessionActive = true;
        await marcarComoOnline();

        heartbeatInterval = setInterval(async () => {
            if (sessionActive && repartidorUID) {
                await marcarComoOnline();
            }
        }, 8000);

        console.log('‚úÖ Heartbeat principal iniciado (cada 8s)');
    }

    function actualizarIndicadorConexion(online) {
        const indicator = document.getElementById('connectionStatus');
        const text = document.getElementById('connectionText');
        
        if (online) {
            indicator.classList.remove('offline');
            indicator.classList.add('active');
            text.textContent = 'üü¢ Online';
        } else {
            indicator.classList.add('offline');
            indicator.classList.add('active');
            text.textContent = 'üî¥ Reconectando...';
        }
    }

    async function marcarComoOnline() {
        if (!repartidorUID || !db) {
            return;
        }

        try {
            const timestamp = Date.now();
            const userStatusRef = ref(db, `repartidores_info/${repartidorUID}`);
            
            await update(userStatusRef, {
                online: true,
                lastSeen: timestamp,
                ultimaConexion: timestamp,
                appVersion: APP_VERSION,
                navegadorActivo: !document.hidden,
                gpsActivo: isTrackingEnabled,
                backgroundMode: isBackgroundMode,
                permisosMultimedia: {
                    camara: permisosCamaraOtorgado,
                    microfono: permisosMicrofonoOtorgado,
                    ubicacion: permisosUbicacionOtorgado
                }
            });
            
            console.log('üíö Online:', new Date(timestamp).toLocaleTimeString());
            actualizarIndicadorConexion(true);
            
        } catch (error) {
            console.error('‚ùå Error al marcar como online:', error);
            actualizarIndicadorConexion(false);
        }
    }

    function detenerHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }
        sessionActive = false;
        console.log('üõë Heartbeat detenido');
    }

    async function marcarComoOffline() {
        if (!repartidorUID || !db) {
            return;
        }

        try {
            const timestamp = Date.now();
            const userStatusRef = ref(db, `repartidores_info/${repartidorUID}`);
            
            await update(userStatusRef, {
                online: false,
                lastSeen: timestamp,
                trackingActivo: false,
                sesionCerradaManualmente: true
            });
            
            console.log('üî¥ Offline marcado correctamente');
            
        } catch (error) {
            console.error('‚ùå Error al marcar como offline:', error);
        }
    }

    async function configurarPresenciaInicial() {
        if (!repartidorUID || !db) {
            console.warn('‚ö†Ô∏è No se puede configurar presencia sin UID');
            return;
        }

        try {
            await marcarComoOnline();
            await iniciarHeartbeatPrincipal();
            
            iniciarEnvioUbicacionDirecto();
            
            console.log('‚úÖ Sistema de presencia persistente configurado');
            actualizarIndicadorConexion(true);
            
        } catch (error) {
            console.error('‚ùå Error al configurar presencia:', error);
        }
    }
    
    // ========================================
    // SISTEMA GPS CORREGIDO
    // ========================================
    
    function iniciarBackgroundGeolocation() {
        if (backgroundGeoInterval) {
            clearInterval(backgroundGeoInterval);
        }

        backgroundGeoInterval = setInterval(async () => {
            if (!repartidorUID) return;
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: 8000,
                            maximumAge: 0
                        }
                    );
                });

                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const speed = position.coords.speed || 0;
                const heading = position.coords.heading || 0;
                const timestamp = Date.now();
                const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;

                const userStatusRef = ref(db, `repartidores_info/${repartidorUID}`);
                await update(userStatusRef, {
                    ubicacion: {
                        lat: parseFloat(lat.toFixed(6)),
                        lon: parseFloat(lon.toFixed(6))
                    },
                    ubicacionActual: {
                        lat: parseFloat(lat.toFixed(6)),
                        lon: parseFloat(lon.toFixed(6)),
                        accuracy: Math.round(accuracy),
                        speed: Math.round(speed * 3.6),
                        heading: Math.round(heading),
                        timestamp: timestamp
                    },
                    ubicacionUrl: googleMapsUrl,
                    trackingActivo: true,
                    lastSeen: timestamp,
                    online: true,
                    backgroundMode: isBackgroundMode
                });

                console.log(`üìç BG GPS: ${lat.toFixed(6)}, ${lon.toFixed(6)} [${isBackgroundMode ? 'BACKGROUND' : 'FOREGROUND'}]`);

            } catch (error) {
                console.warn('‚ö†Ô∏è Error en background GPS:', error.message);
            }
        }, 3000);

        console.log('‚úÖ Background Geolocation iniciado (cada 3s)');
    }

    function detenerBackgroundGeolocation() {
        if (backgroundGeoInterval) {
            clearInterval(backgroundGeoInterval);
            backgroundGeoInterval = null;
            console.log('üõë Background Geolocation detenido');
        }
    }

    function iniciarEnvioUbicacionDirecto() {
        if (locationSendInterval) {
            clearInterval(locationSendInterval);
        }

        locationSendInterval = setInterval(async () => {
            if (isTrackingEnabled && repartidorUID && lastLocationUpdate > 0) {
                try {
                    const userStatusRef = ref(db, `repartidores_info/${repartidorUID}`);
                    await update(userStatusRef, {
                        trackingActivo: true,
                        lastSeen: Date.now(),
                        online: true
                    });
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error en env√≠o directo de ubicaci√≥n:', error);
                }
            }
        }, 5000);

        console.log('‚úÖ Env√≠o directo de ubicaci√≥n iniciado');
    }

    async function iniciarTrackingGPSAutomatico() {
        console.log('üöÄ Iniciando GPS autom√°tico al login...');
        
        if (!permisosUbicacionOtorgado) {
            console.warn('‚ö†Ô∏è No se puede iniciar GPS sin permisos de ubicaci√≥n');
            return;
        }
        
        const esAPK = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone ||
                      document.referrer.includes('android-app://');
        
        if (esAPK) {
            console.log('üì± Detectado APK Android - Verificando permisos nativos...');
        }
        
        await solicitarWakeLock();
        await iniciarTrackingGPS();
        iniciarBackgroundGeolocation();
        
        document.getElementById('gpsIndicator').classList.add('active');
    }

    function iniciarTrackingGPS() {
        if (!navigator.geolocation) {
            console.error('‚ùå Geolocalizaci√≥n no soportada');
            return;
        }
        
        if (isTrackingEnabled) {
            console.log('‚ö†Ô∏è GPS ya est√° activo');
            return;
        }
        
        console.log('üìç Iniciando tracking GPS mejorado...');
        isTrackingEnabled = true;
        gpsErrorCount = 0;
        
        const esAPK = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone ||
                      document.referrer.includes('android-app://');
        
        const geoOptions = {
            enableHighAccuracy: true,
            timeout: esAPK ? 15000 : 10000,
            maximumAge: 0
        };
        
        console.log(`üì± Modo: ${esAPK ? 'APK Android' : 'Web'}`);
        
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const now = Date.now();
                
                if (now - lastLocationUpdate < LOCATION_UPDATE_INTERVAL) {
                    return;
                }
                
                lastLocationUpdate = now;
                gpsErrorCount = 0;
                
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const speed = position.coords.speed || 0;
                const heading = position.coords.heading || 0;
                
                console.log(`üìç GPS OK [${esAPK ? 'APK' : 'Web'}]: ${lat.toFixed(6)}, ${lon.toFixed(6)} (¬±${Math.round(accuracy)}m)`);
                
                enviarUbicacionAFirebase(lat, lon, accuracy, speed, heading);
                enviarUbicacionDirecta(lat, lon, accuracy, speed, heading);
            },
            (error) => {
                gpsErrorCount++;
                console.error(`‚ùå Error GPS [${esAPK ? 'APK' : 'Web'}] (${gpsErrorCount}/${MAX_GPS_ERRORS}):`, error.message);
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        console.error('‚ö†Ô∏è Permiso GPS denegado');
                        if (esAPK) {
                            alert('‚ö†Ô∏è Permiso de ubicaci√≥n denegado.\n\nPara que funcione en APK:\n\n1. Configuraci√≥n ‚Üí Aplicaciones\n2. Servi Aliados ‚Üí Permisos\n3. Ubicaci√≥n ‚Üí "Permitir TODO EL TIEMPO"');
                        }
                        detenerTrackingGPS();
                        break;
                    case error.POSITION_UNAVAILABLE:
                        console.warn('üì° Se√±al GPS d√©bil, reintentando...');
                        break;
                    case error.TIMEOUT:
                        console.warn('‚è±Ô∏è Timeout GPS, reintentando...');
                        break;
                }
            },
            geoOptions
        );
        
        console.log('‚úÖ GPS iniciado - Actualizaci√≥n cada 2 segundos');
    }

    function detenerTrackingGPS() {
        if (!isTrackingEnabled) {
            return;
        }
        
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
        
        if (locationSendInterval) {
            clearInterval(locationSendInterval);
            locationSendInterval = null;
        }
        
        detenerBackgroundGeolocation();
        
        isTrackingEnabled = false;
        console.log('üõë GPS detenido');
        
        document.getElementById('gpsIndicator').classList.remove('active');
        
        if (repartidorUID) {
            update(ref(db, `repartidores_info/${repartidorUID}`), {
                trackingActivo: false,
                ultimaUbicacionTimestamp: Date.now()
            });
        }
    }

    async function enviarUbicacionAFirebase(lat, lon, accuracy, speed, heading) {
        if (!repartidorUID) return;

        try {
            const timestamp = Date.now();
            const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
            
            await update(ref(db, `repartidores_info/${repartidorUID}`), {
                ubicacion: {
                    lat: parseFloat(lat.toFixed(6)),
                    lon: parseFloat(lon.toFixed(6))
                },
                ubicacionActual: {
                    lat: parseFloat(lat.toFixed(6)),
                    lon: parseFloat(lon.toFixed(6)),
                    accuracy: Math.round(accuracy),
                    speed: Math.round(speed * 3.6),
                    heading: Math.round(heading),
                    timestamp: timestamp
                },
                ubicacionUrl: googleMapsUrl,
                trackingActivo: true,
                lastSeen: timestamp,
                online: true
            });
            
            console.log(`üìç Ubicaci√≥n Firebase SDK: ${lat.toFixed(6)}, ${lon.toFixed(6)}`);
            
        } catch (error) {
            console.error('‚ùå Error al enviar ubicaci√≥n Firebase SDK:', error);
        }
    }

    async function enviarUbicacionDirecta(lat, lon, accuracy, speed, heading) {
        if (!repartidorUID) return;

        try {
            const timestamp = Date.now();
            const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
            
            const pedidosSnapshot = await get(ref(db, 'pedidos_pendientes'));
            const pedidosData = pedidosSnapshot.val();
            
            if (pedidosData) {
                const promesas = [];
                
                Object.keys(pedidosData).forEach(pedidoId => {
                    const pedido = pedidosData[pedidoId];
                    
                    if (pedido.repartidorUID === repartidorUID && pedido.estado !== 'Pendiente') {
                        const pedidoRef = ref(db, `pedidos_pendientes/${pedidoId}`);
                        
                        promesas.push(
                            update(pedidoRef, {
                                ubicacionRepartidor: {
                                    lat: parseFloat(lat.toFixed(6)),
                                    lon: parseFloat(lon.toFixed(6)),
                                    accuracy: Math.round(accuracy ),
                                    speed: Math.round(speed * 3.6),
                                    heading: Math.round(heading),
                                    timestamp: timestamp,
                                    googleMapsUrl: googleMapsUrl
                                }
                            })
                        );
                    }
                });
                
                await Promise.all(promesas);
            }

            console.log(`‚úÖ Ubicaci√≥n enviada [${new Date(timestamp).toLocaleTimeString()}]`);

        } catch (error) {
            console.error('‚ùå Error al enviar ubicaci√≥n:', error);
        }
    }

    // ========================================
    // WAKE LOCK API
    // ========================================
    
    async function solicitarWakeLock() {
        if (!isWakeLockSupported) {
            console.warn('‚ö†Ô∏è Wake Lock no soportado en este navegador');
            return false;
        }

        try {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('‚úÖ Wake Lock activado - App permanecer√° activa');
            
            wakeLock.addEventListener('release', () => {
                console.log('‚ö†Ô∏è Wake Lock liberado');
            });
            
            return true;
        } catch (error) {
            console.error('‚ùå Error al solicitar Wake Lock:', error);
            return false;
        }
    }

    async function liberarWakeLock() {
        if (wakeLock !== null) {
            try {
                await wakeLock.release();
                wakeLock = null;
                console.log('üõë Wake Lock liberado');
            } catch (error) {
                console.error('‚ùå Error al liberar Wake Lock:', error);
            }
        }
    }

    function limpiarRecursos() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        if (locationSendInterval) {
            clearInterval(locationSendInterval);
            locationSendInterval = null;
        }
        console.log('üßπ Recursos limpiados');
    }

    // ========================================
    // FUNCIONES DE UTILIDAD
    // ========================================
    
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        const pad = (num) => num.toString().padStart(2, '0');
        return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }
    
    function updateTimers() {
        if (timerInterval) clearInterval(timerInterval); 
        timerInterval = setInterval(() => {
            document.querySelectorAll('.pedido-item.asignado-timer').forEach(item => {
                const timestampElement = item.querySelector('.timestamp-aceptado');
                const timerElement = item.querySelector('.timer');
                if (timestampElement && timerElement) {
                    const timestamp = parseInt(timestampElement.textContent);
                    const elapsed = Date.now() - timestamp;
                    timerElement.textContent = `‚è±Ô∏è Tiempo: ${formatTime(elapsed)}`;
                }
            });
        }, 1000);
    }
    
    function playNotificationSound() {
        const audio = document.getElementById('notificationSound');
        if (audio) {
            audio.pause(); 
            audio.currentTime = 0;
            audio.play().catch(error => console.warn("Error audio:", error));
        }
    }

    function showSection(sectionId) {
        document.getElementById('chatSection').style.display = 'none';
        document.getElementById('pendientesSection').style.display = 'none';
        document.getElementById('asignadosSection').style.display = 'none';
        document.getElementById('historialSection').style.display = 'none';
        document.getElementById(sectionId).style.display = 'block';
    }

    document.getElementById('showChatBtn').addEventListener('click', () => showSection('chatSection'));
    document.getElementById('showPendientesBtn').addEventListener('click', () => showSection('pendientesSection'));
    document.getElementById('showAsignadosBtn').addEventListener('click', () => {
        showSection('asignadosSection');
        updateTimers(); 
    });
    document.getElementById('showHistorialBtn').addEventListener('click', () => { 
        showSection('historialSection');
        listenForHistorial(); 
    });

    // ========================================
    // COMPLETAR PEDIDO
    // ========================================
    
    window.completarPedido = async function(pedidoId) {
        if (!confirm(`‚úÖ ¬øConfirmas que entregaste este pedido exitosamente?`)) {
            return;
        }

        try {
            console.log(`üîÑ Completando pedido: ${pedidoId}`);
            
            const pedidoPendienteRef = ref(db, `pedidos_pendientes/${pedidoId}`);
            const snapshot = await get(pedidoPendienteRef);
            
            if (!snapshot.exists()) {
                console.error('‚ùå Pedido no encontrado en pedidos_pendientes');
                alert('‚ùå Error: El pedido no existe o ya fue procesado');
                return;
            }
            
            const pedidoData = snapshot.val();
            console.log('üì¶ Datos del pedido obtenidos:', pedidoData);
            
            const pedidoCompletado = {
                ...pedidoData,
                estado: 'Completado',
                estadoHistorial: 'Completado',
                timestampEntregado: Date.now(),
                timestampCompletado: Date.now(),
                completadoPor: repartidorNombre,
                repartidorUID: repartidorUID,
                id: pedidoId
            };
            
            const historialRef = ref(db, `pedidos_historial/${pedidoId}`);
            await set(historialRef, pedidoCompletado);
            console.log('‚úÖ Pedido guardado en historial');
            
            if (pedidoData.clienteIdAsignado) {
                const clienteRef = ref(db, `users/${pedidoData.clienteIdAsignado}`);
                await update(clienteRef, {
                    pedidoActivoId: null,
                    tienePedidoAsignado: false,
                    ultimoPedidoCompletado: pedidoId,
                    timestampUltimaEntrega: Date.now()
                });
            }
            
            await remove(pedidoPendienteRef);
            delete pedidosActivos[pedidoId];
            
            window.detenerSeguimiento();
            
            alert('‚úÖ ¬°Entrega registrada exitosamente!');
            console.log('üéâ Pedido completado exitosamente:', pedidoId);
            
        } catch (error) {
            console.error('‚ùå Error al completar pedido:', error);
            alert(`‚ùå Error al completar el pedido:\n\n${error.message}`);
        }
    }

    // ========================================
    // üî• AVANZAR ESTADO PEDIDO (MEJORADO CON DEBUG)
    // ========================================
    
    window.avanzarEstadoPedido = async function(pedidoId, estadoActual) {
        const pedidoRef = ref(db, `pedidos_pendientes/${pedidoId}`);
        let proximoEstado = "";
        let mensajeAlerta = "";

        if (estadoActual === 'Pendiente') {
            if (confirm(`¬øDeseas tomar este pedido?`)) {
                proximoEstado = 'Aceptado';
                mensajeAlerta = "‚úÖ Pedido Aceptado. Dir√≠gete al punto de recogida.";
                
                try {
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('üîç ACEPTANDO PEDIDO - B√öSQUEDA DE CLIENTE ID');
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    
                    // Obtener datos completos del pedido
                    const pedidoSnapshot = await get(pedidoRef);
                    const pedidoData = pedidoSnapshot.val();
                    
                    console.log('üì¶ Datos completos del pedido:', pedidoData);
                    console.log('');
                    console.log('üîé Buscando clienteID en diferentes campos:');
                    console.log('   clienteIdAsignado:', pedidoData?.clienteIdAsignado);
                    console.log('   clienteID:', pedidoData?.clienteID);
                    console.log('   usuarioId:', pedidoData?.usuarioId);
                    console.log('   userId:', pedidoData?.userId);
                    console.log('   cliente_id:', pedidoData?.cliente_id);
                    console.log('   user_id:', pedidoData?.user_id);
                    console.log('   clientId:', pedidoData?.clientId);
                    console.log('');
                    
                    // Buscar clienteID en TODOS los campos posibles
                    const clienteID = pedidoData?.clienteIdAsignado || 
                                     pedidoData?.clienteID || 
                                     pedidoData?.usuarioId ||
                                     pedidoData?.userId ||
                                     pedidoData?.cliente_id ||
                                     pedidoData?.user_id ||
                                     pedidoData?.clientId;
                    
                    console.log('‚úÖ Cliente ID seleccionado:', clienteID);
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('');
                    
                    if (!clienteID) {
                        console.error('‚ùå ERROR CR√çTICO: NO SE ENCONTR√ì CLIENTE ID EN NING√öN CAMPO');
                        console.error('Estructura completa del pedido:', JSON.stringify(pedidoData, null, 2));
                        alert('‚ùå ERROR: Este pedido no tiene un cliente asociado.\n\nNo se puede iniciar el seguimiento.\n\nContacta al administrador.');
                    }
                    
                    if (navigator.geolocation) {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            });
                        });
                        
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
                        
                        await update(pedidoRef, {
                            estado: proximoEstado,
                            repartidorAsignado: repartidorNombre,
                            repartidorUID: repartidorUID,
                            repartidorIdAsignado: repartidorUID,
                            timestampAceptado: Date.now(),
                            ubicacionRepartidor: {
                                lat: parseFloat(lat.toFixed(6)),
                                lon: parseFloat(lon.toFixed(6)),
                                accuracy: Math.round(position.coords.accuracy),
                                speed: Math.round((position.coords.speed || 0) * 3.6),
                                heading: Math.round(position.coords.heading || 0),
                                timestamp: Date.now(),
                                googleMapsUrl: googleMapsUrl
                            }
                        });
                    } else {
                        await update(pedidoRef, {
                            estado: proximoEstado,
                            repartidorAsignado: repartidorNombre,
                            repartidorUID: repartidorUID,
                            repartidorIdAsignado: repartidorUID,
                            timestampAceptado: Date.now()
                        });
                    }
                    
                    pedidosActivos[pedidoId] = {
                        estado: 'Aceptado',
                        timestamp: Date.now()
                    };
                    
                    // Iniciar seguimiento del cliente si existe clienteID
                    if (clienteID) {
                        console.log('üó∫Ô∏è Iniciando mapa y seguimiento del cliente...');
                        
                        // Mostrar contenedor del mapa
                        document.getElementById('mapa-cliente-container').style.display = 'block';
                        
                        // Inicializar mapa si no existe
                        if (!mapaCliente) {
                            inicializarMapaCliente();
                        }
                        
                        // Iniciar GPS del repartidor
                        iniciarEnvioUbicacionRepartidor();
                        
                        // Iniciar seguimiento del cliente
                        iniciarSeguimientoCliente(clienteID);
                        
                        // Cambiar texto del bot√≥n
                        document.getElementById('verMapaBtn').textContent = 'üó∫Ô∏è Ocultar Mapa';
                        
                        console.log('‚úÖ Sistemas de seguimiento iniciados');
                    } else {
                        console.error('‚ùå No se puede iniciar seguimiento: clienteID no encontrado');
                    }
                    
                    console.log(mensajeAlerta);
                    showSection('asignadosSection');
                } catch (error) {
                    console.error('‚ùå Error al aceptar pedido:', error);
                    alert('‚ùå Error al aceptar el pedido: ' + error.message);
                }
            }
            return;
        }

        if (estadoActual === 'Aceptado') {
            proximoEstado = 'Esperando Pedido';
            mensajeAlerta = "‚è≥ Estado actualizado: Esperando el despacho en el sitio.";
        } else if (estadoActual === 'Esperando Pedido') {
            proximoEstado = 'En Camino';
            mensajeAlerta = "üöö ¬°Buen viaje! El administrador y el cliente saben que vas en camino.";
        }

        if (proximoEstado) {
            try {
                await update(pedidoRef, { estado: proximoEstado });
                
                if (pedidosActivos[pedidoId]) {
                    pedidosActivos[pedidoId].estado = proximoEstado;
                }
                
                console.log(mensajeAlerta);
            } catch (error) {
                console.error('‚ùå Error al actualizar estado:', error);
                alert('‚ùå Error al actualizar el estado');
            }
        }
    };

    // ========================================
    // CANCELACI√ìN DE PEDIDOS
    // ========================================

    window.iniciarCancelacion = (pedidoId) => {
        currentPedidoIdToCancel = pedidoId;
        document.getElementById('cancelModal').style.display = 'flex';
    }
    
    window.ejecutarCancelacionConMotivo = async (motivo) => {
        try {
            console.log(`üîÑ Cancelando pedido: ${currentPedidoIdToCancel}`);
            
            const pedidoPendienteRef = ref(db, `pedidos_pendientes/${currentPedidoIdToCancel}`);
            const snapshot = await get(pedidoPendienteRef);
            
            if (!snapshot.exists()) {
                console.error('‚ùå Pedido no encontrado');
                alert('‚ùå Error: El pedido no existe');
                return;
            }
            
            const pedidoData = snapshot.val();
            
            const pedidoCancelado = {
                ...pedidoData,
                estado: 'Cancelado',
                estadoHistorial: 'Cancelado',
                timestampCancelado: Date.now(),
                motivoCancelacion: motivo,
                canceladoPor: repartidorNombre,
                repartidorUID: repartidorUID,
                id: currentPedidoIdToCancel
            };
            
            await set(ref(db, `pedidos_historial/${currentPedidoIdToCancel}`), pedidoCancelado);
            
            if (pedidoData.clienteIdAsignado) {
                const clienteRef = ref(db, `users/${pedidoData.clienteIdAsignado}`);
                await update(clienteRef, {
                    pedidoActivoId: null,
                    tienePedidoAsignado: false,
                    ultimoPedidoCancelado: currentPedidoIdToCancel,
                    timestampUltimaCancelacion: Date.now()
                });
            }
            
            await remove(pedidoPendienteRef);
            delete pedidosActivos[currentPedidoIdToCancel];
            
            window.detenerSeguimiento();
            
            alert(`‚ùå Pedido cancelado correctamente.\n\nMotivo: ${motivo}`);
            
        } catch (error) {
            console.error('‚ùå Error al cancelar pedido:', error);
            alert('‚ùå Error al cancelar el pedido: ' + error.message);
        }
        
        document.getElementById('cancelModal').style.display = 'none';
    }

    // ========================================
    // LISTENER DE PEDIDOS
    // ========================================

    function listenForPedidos() {
        onValue(ref(db, 'pedidos_pendientes'), (snapshot) => {
            const pedidosList = document.getElementById('pedidosList');
            const pedidosAsignadosList = document.getElementById('pedidosAsignadosList');
            const pendientesBadge = document.getElementById('pendientesBadge');
            
            pedidosList.innerHTML = '';
            pedidosAsignadosList.innerHTML = '';
            let asignadosCount = 0;
            let pendientesCount = 0;
            const data = snapshot.val();
            
            const pedidosAnteriores = localStorage.getItem('lastPedidosCount') ? parseInt(localStorage.getItem('lastPedidosCount')) : 0;
            let tieneNuevoPedido = false; 

            if (!data) {
                pedidosList.innerHTML = '<p>No hay pedidos pendientes.</p>';
                pedidosAsignadosList.innerHTML = '<p>No tienes pedidos asignados.</p>';
                document.getElementById('asignadosCount').textContent = 0;
                pendientesBadge.style.display = 'none';
                localStorage.setItem('lastPedidosCount', 0);
                
                initialLoad = false;
                return;
            }

            const pedidosEnFirebase = Object.keys(data);
            Object.keys(pedidosActivos).forEach(pedidoId => {
                if (!pedidosEnFirebase.includes(pedidoId)) {
                    delete pedidosActivos[pedidoId];
                }
            });

            Object.keys(data).forEach(pedidoId => {
                const pedido = data[pedidoId];
                const item = document.createElement('div');
                item.classList.add('pedido-item');
                
                const contentHTML = `
                    <p><strong>ID:</strong> ${pedidoId.substring(0, 8)}...</p>
                    <p><strong>Cliente:</strong> ${pedido.nombreCliente}</p>
                    <p><strong>Tel√©fono:</strong> ${pedido.telefonoCliente}</p>
                    <p><strong>Direcci√≥n:</strong> ${pedido.direccionCliente}</p>
                    <p><strong>Descripci√≥n:</strong> ${pedido.descripcion}</p>
                    <p><strong>Monto:</strong> $${pedido.montoTotal.toLocaleString('es-CO')}</p>
                `;
                
                if (pedido.estado === 'Pendiente') {
                    pendientesCount++;
                    item.innerHTML = contentHTML + `
                        <button onclick="window.avanzarEstadoPedido('${pedidoId}', 'Pendiente')" style="background: #4CAF50; color: white; width: 100%;">‚úÖ Aceptar Pedido</button>
                    `;
                    pedidosList.appendChild(item);
                    if (!localStorage.getItem(`pedido_seen_${pedidoId}`)) tieneNuevoPedido = true;

                } else if (pedido.repartidorUID === repartidorUID) {
                    asignadosCount++;
                    item.classList.add('asignado-timer');
                    
                    let mainBtn = "";
                    if (pedido.estado === 'Aceptado') {
                        item.classList.add('asignado');
                        mainBtn = `<button onclick="window.avanzarEstadoPedido('${pedidoId}', 'Aceptado')" style="background: var(--color-waiting); color:white; flex-grow: 1;">‚è≥ Estoy Esperando</button>`;
                    } else if (pedido.estado === 'Esperando Pedido') {
                        item.classList.add('esperando');
                        mainBtn = `<button onclick="window.avanzarEstadoPedido('${pedidoId}', 'Esperando Pedido')" style="background: var(--color-delivery); color:white; flex-grow: 1;">üöö Salgo a Entregar</button>`;
                    } else if (pedido.estado === 'En Camino') {
                        item.classList.add('en-camino');
                        mainBtn = `<button onclick="window.completarPedido('${pedidoId}')" style="background: #27ae60; color:white; flex-grow: 1;">‚úÖ Entrega Completada</button>`;
                    }

                    item.innerHTML = `
                        <p style="text-align:right;">Estado: <strong style="color:white;">${pedido.estado}</strong></p>
                        ${contentHTML}
                        <span class="timestamp-aceptado" style="display:none;">${pedido.timestampAceptado}</span>
                        <span class="timer">‚è±Ô∏è Tiempo: Cargando...</span>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            ${mainBtn}
                            <button onclick="window.iniciarCancelacion('${pedidoId}')" style="background:var(--color-accent-danger); color:white; flex-grow: 0.5;">‚ùå Cancelar</button>
                        </div>
                    `;
                    pedidosAsignadosList.appendChild(item);
                }
                localStorage.setItem(`pedido_seen_${pedidoId}`, true);
            });
            
            const pedidosActuales = Object.keys(data).length;
            if (!initialLoad && (pedidosActuales > pedidosAnteriores || tieneNuevoPedido)) {
                pendientesBadge.style.display = 'block';
                playNotificationSound(); 
            }
            
            document.getElementById('asignadosCount').textContent = asignadosCount;
            pendientesBadge.style.display = pendientesCount > 0 ? 'block' : 'none';
            localStorage.setItem('lastPedidosCount', pedidosActuales);
            initialLoad = false;
            updateTimers();
        });
    }

    // ========================================
    // HISTORIAL
    // ========================================

    function listenForHistorial() {
        onValue(ref(db, 'pedidos_historial'), (snapshot) => {
            const list = document.getElementById('pedidosHistorialList');
            const data = snapshot.val();
            list.innerHTML = '';
            
            if (!data) { 
                list.innerHTML = '<p>Historial vac√≠o.</p>'; 
                return; 
            }
            
            let historialDelRepartidor = [];
            
            Object.keys(data).forEach(id => {
                const p = data[id];
                if (p.repartidorUID === repartidorUID) {
                    historialDelRepartidor.push({ id, ...p });
                }
            });
            
            historialDelRepartidor.sort((a, b) => {
                const timestampA = a.timestampEntregado || a.timestampCancelado || 0;
                const timestampB = b.timestampEntregado || b.timestampCancelado || 0;
                return timestampB - timestampA;
            });
            
            if (historialDelRepartidor.length === 0) {
                list.innerHTML = '<p>No tienes historial a√∫n.</p>';
                return;
            }
            
            historialDelRepartidor.forEach(p => {
                const item = document.createElement('div');
                item.className = 'pedido-item';
                item.style.borderLeftColor = p.estado === 'Completado' ? '#27ae60' : 'var(--color-accent-danger)';
                
                const fecha = new Date(p.timestampEntregado || p.timestampCancelado).toLocaleString('es-CO', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                item.innerHTML = `
                    <p><strong>ID:</strong> ${p.id.substring(0, 8)}...</p>
                    <p><strong>Estado:</strong> <span style="color: ${p.estado === 'Completado' ? '#27ae60' : 'var(--color-accent-danger)'};">${p.estado}</span></p>
                    <p><strong>Cliente:</strong> ${p.nombreCliente}</p>
                    <p><strong>Monto:</strong> $${p.montoTotal.toLocaleString('es-CO')}</p>
                    ${p.motivoCancelacion ? `<p><strong>Motivo:</strong> ${p.motivoCancelacion}</p>` : ''}
                    <p><small>üìÖ ${fecha}</small></p>
                `;
                list.appendChild(item);
            });
        });
    }

    // ========================================
    // CHAT
    // ========================================

    function listenForChat() {
        onValue(ref(db, `chats/${repartidorUID}`), (snapshot) => {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = '';
            const mensajes = snapshot.val();
            
            if (!mensajes) { 
                chatBox.innerHTML = '<p style="text-align: center; color: #999;">Sin mensajes del admin.</p>'; 
                return; 
            }
            
            Object.keys(mensajes).sort((a,b) => mensajes[a].timestamp - mensajes[b].timestamp).forEach(key => {
                const d = mensajes[key];
                const div = document.createElement('div');
                div.className = `mensaje ${d.rol_remitente === "Admin" ? 'admin-msg' : 'rep-msg'}`;
                
                let contenido = '';
                
                const esAudio = (d.tipo === 'audio' || d.tipo_adjunto === 'audio') && 
                               (d.audioURL || d.referencia_adjunto);
                
                const esImagen = (d.tipo === 'imagen' && d.imagenURL) || 
                                (d.tipo_adjunto === 'imagen' && d.referencia_adjunto);
                
                const audioURL = d.audioURL || d.referencia_adjunto;
                const imagenURL = d.imagenURL || d.referencia_adjunto;
                
                if (esImagen) {
                    contenido = `<img src="${imagenURL}" alt="Imagen" onclick="window.verImagenCompleta('${imagenURL}')" style="max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 5px; display: block; cursor: pointer;">`;
                    
                    if (d.texto && !d.texto.includes('üé§') && !d.texto.includes('üì∑')) {
                        contenido = `<p style="margin-bottom: 5px;">${d.texto}</p>` + contenido;
                    }
                } 
                else if (esAudio) {
                    const esDelAdmin = d.rol_remitente === "Admin";
                    const audioId = `audio_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    
                    contenido = `
                        <div style="
                            background: #E8E8E8;
                            padding: 10px 15px;
                            border-radius: 20px;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            max-width: 250px;
                        ">
                            <button onclick="toggleAudio('${audioId}')" style="
                                background: ${esDelAdmin ? '#FFC300' : '#555'};
                                border: none;
                                border-radius: 50%;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                cursor: pointer;
                                font-size: 18px;
                                color: white;
                                flex-shrink: 0;
                            " id="btn_${audioId}">
                                ‚ñ∂Ô∏è
                            </button>
                            <audio id="${audioId}" src="${audioURL}" style="display: none;"></audio>
                            <span style="
                                font-size: 12px;
                                color: #555;
                                flex-grow: 1;
                            ">[Reproducir Audio]</span>
                        </div>
                    `;
                }
                else if (d.texto && !d.texto.includes('üé§') && !d.texto.includes('üì∑')) {
                    contenido = `<p style="margin: 0; word-wrap: break-word;">${d.texto}</p>`;
                } 
                else {
                    contenido = `<p style="margin: 0; opacity: 0.6; font-style: italic;">Mensaje sin contenido</p>`;
                }
                
                const hora = new Date(d.timestamp).toLocaleTimeString('es-CO', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                div.innerHTML = `
                    ${contenido}
                    <span class="chat-time" style="font-size: 10px; margin-top: 3px; display: block; text-align: right; opacity: 0.7;">${hora}</span>
                `;
                
                chatBox.appendChild(div);
            });
            
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    window.verImagenCompleta = function(imageUrl) {
        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('imageModal').classList.add('active');
    };

    window.toggleAudio = function(audioId) {
        const audio = document.getElementById(audioId);
        const btn = document.getElementById('btn_' + audioId);
        
        if (!audio || !btn) return;
        
        if (audio.paused) {
            audio.play();
            btn.innerHTML = '‚è∏Ô∏è';
            
            audio.onended = () => {
                btn.innerHTML = '‚ñ∂Ô∏è';
            };
        } else {
            audio.pause();
            audio.currentTime = 0;
            btn.innerHTML = '‚ñ∂Ô∏è';
        }
    };

    document.getElementById('enviarBtn').addEventListener('click', enviarMensaje);
    document.getElementById('mensajeInput').addEventListener('keypress', (e) => { 
        if (e.key === "Enter") enviarMensaje(); 
    });
    
    async function enviarMensaje() {
        const input = document.getElementById('mensajeInput');
        const texto = input.value.trim();
        
        if (selectedImageFile) {
            try {
                const timestamp = Date.now();
                const imagePath = `chats/${repartidorUID}/imagenes/imagen_${timestamp}.jpg`;
                const imageURL = await uploadFileToStorage(selectedImageFile, imagePath);
                
                await push(ref(db, `chats/${repartidorUID}`), {
                    remitente: repartidorNombre,
                    tipo: 'imagen',
                    imagenURL: imageURL,
                    texto: texto || '',
                    timestamp: timestamp,
                    rol_remitente: "Repartidor"
                });
                
                selectedImageFile = null;
                document.getElementById('imagePreview').classList.remove('active');
                document.getElementById('galleryInput').value = '';
                input.value = '';
                
            } catch (error) {
                console.error('‚ùå Error al enviar imagen:', error);
                alert('‚ùå Error al enviar la imagen');
            }
        } 
        else if (texto) {
            try {
                await push(ref(db, `chats/${repartidorUID}`), {
                    remitente: repartidorNombre,
                    tipo: 'texto',
                    texto: texto,
                    timestamp: Date.now(),
                    rol_remitente: "Repartidor"
                });
                input.value = '';
            } catch (error) {
                console.error('‚ùå Error al enviar mensaje:', error);
                alert('‚ùå Error al enviar el mensaje');
            }
        }
    }

    // ========================================
    // MULTIMEDIA
    // ========================================

    async function uploadFileToStorage(file, path) {
        return new Promise((resolve, reject) => {
            const fileRef = storageRef(storage, path);
            const uploadTask = uploadBytesResumable(fileRef, file);
            
            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressDiv.classList.add('active');
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressFill.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                },
                (error) => {
                    progressDiv.classList.remove('active');
                    reject(error);
                },
                async () => {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    progressDiv.classList.remove('active');
                    progressFill.style.width = '0%';
                    progressText.textContent = '0%';
                    resolve(downloadURL);
                }
            );
        });
    }
    
    document.getElementById('sendGalleryBtn').addEventListener('click', () => {
        if (!permisosCamaraOtorgado) {
            alert('‚ö†Ô∏è No tienes permiso de c√°mara/fotos.\n\nActiva los permisos desde el men√∫ al iniciar sesi√≥n.');
            return;
        }
        
        document.getElementById('galleryInput').click();
    });
    
    document.getElementById('galleryInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            selectedImageFile = file;
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('previewImg').src = event.target.result;
                document.getElementById('imagePreview').classList.add('active');
            };
            reader.readAsDataURL(file);
        }
    });
    
    document.getElementById('cancelImageBtn').addEventListener('click', () => {
        selectedImageFile = null;
        document.getElementById('imagePreview').classList.remove('active');
        document.getElementById('galleryInput').value = '';
    });

    // GRABACI√ìN DE AUDIO

    async function iniciarGrabacionAudio() {
        if (!permisosMicrofonoOtorgado) {
            alert('‚ö†Ô∏è No tienes permiso de micr√≥fono.\n\nActiva los permisos desde el men√∫ al iniciar sesi√≥n.');
            return;
        }
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            audioChunks = [];
            
            const mimeType = MediaRecorder.isTypeSupported('audio/webm') 
                ? 'audio/webm' 
                : 'audio/mp4';
            
            mediaRecorder = new MediaRecorder(stream, { 
                mimeType: mimeType,
                audioBitsPerSecond: 128000 
            });
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = () => {
                stream.getTracks().forEach(track => track.stop());
                
                const audioBlob = new Blob(audioChunks, { type: mimeType });
                mostrarPreviewAudio(audioBlob);
                
                document.getElementById('recordingIndicator').classList.remove('active');
                clearInterval(recordingTimerInterval);
                document.getElementById('recordAudioBtn').innerHTML = 'üé§ Grabar Audio';
            };
            
            mediaRecorder.start();
            recordingStartTime = Date.now();
            
            document.getElementById('recordingIndicator').classList.add('active');
            document.getElementById('recordAudioBtn').innerHTML = '‚èπÔ∏è Detener';
            
            recordingTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('recordingTimer').textContent = `${minutes}:${seconds}`;
            }, 1000);
            
        } catch (error) {
            console.error('‚ùå Error al iniciar grabaci√≥n:', error);
            
            if (error.name === 'NotAllowedError') {
                alert('‚ö†Ô∏è Permiso de micr√≥fono denegado.');
            } else {
                alert('‚ùå Error al acceder al micr√≥fono: ' + error.message);
            }
        }
    }

    function detenerGrabacionAudio() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
    }

    function mostrarPreviewAudio(audioBlob) {
        const audioPreview = document.getElementById('audioPreview');
        const previewAudio = document.getElementById('previewAudio');
        
        const audioURL = URL.createObjectURL(audioBlob);
        previewAudio.src = audioURL;
        
        selectedAudioFile = new File(
            [audioBlob], 
            `audio_${Date.now()}.${audioBlob.type.includes('webm') ? 'webm' : 'mp4'}`,
            { type: audioBlob.type }
        );
        
        audioPreview.style.display = 'block';
    }

    document.getElementById('recordAudioBtn').addEventListener('click', async () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            detenerGrabacionAudio();
            return;
        }
        
        await iniciarGrabacionAudio();
    });

    document.getElementById('stopRecordingBtn').addEventListener('click', () => {
        detenerGrabacionAudio();
    });

    document.getElementById('sendAudioFileBtn').addEventListener('click', async () => {
        if (!selectedAudioFile) {
            alert('‚ö†Ô∏è No hay audio para enviar');
            return;
        }
        
        await enviarAudioSeleccionado(selectedAudioFile);
        
        selectedAudioFile = null;
        document.getElementById('audioPreview').style.display = 'none';
    });

    document.getElementById('cancelAudioBtn').addEventListener('click', () => {
        selectedAudioFile = null;
        document.getElementById('audioPreview').style.display = 'none';
        
        const previewAudio = document.getElementById('previewAudio');
        previewAudio.pause();
        previewAudio.src = '';
        
        audioChunks = [];
    });

    async function enviarAudioSeleccionado(audioFile) {
        if (!repartidorUID) {
            alert('‚ùå Error: No se pudo identificar al usuario');
            return;
        }
        
        try {
            const timestamp = Date.now();
            const extension = audioFile.name.split('.').pop() || 'mp3';
            const audioPath = `chats/${repartidorUID}/audios/audio_${timestamp}.${extension}`;
            
            const progressDiv = document.getElementById('uploadProgress');
            progressDiv.classList.add('active');
            
            const audioURL = await uploadFileToStorage(audioFile, audioPath);
            
            const duracionEstimada = Math.ceil(audioFile.size / 16000);
            
            await push(ref(db, `chats/${repartidorUID}`), {
                remitente: repartidorNombre,
                nombre_remitente: repartidorNombre,
                texto: 'üéôÔ∏è Audio',
                timestamp: timestamp,
                rol_remitente: "Repartidor",
                tipo_adjunto: 'audio',
                referencia_adjunto: audioURL,
                duracion: duracionEstimada,
                tamano_kb: Math.round(audioFile.size / 1024),
                pedidoID: 'N/A'
            });
            
            progressDiv.classList.remove('active');
            
        } catch (error) {
            console.error('‚ùå Error al enviar audio:', error);
            alert('‚ùå Error al enviar el audio: ' + error.message);
            
            document.getElementById('uploadProgress').classList.remove('active');
        }
    }

    // ========================================
    // SISTEMA DE LOGIN Y REGISTRO
    // ========================================

    function saveQuickLoginData(email, password, name) {
        localStorage.setItem('lastRepartidorEmail', email);
        localStorage.setItem('lastRepartidorPassword', password);
        localStorage.setItem('lastRepartidorName', name);
    }
    
    function showRegistrationForm(email) {
        document.getElementById('manualLoginForm').style.display = 'none';
        document.getElementById('registrationForm').style.display = 'block';
        document.getElementById('regEmailDisplay').value = email;
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('appContainer').style.display = 'none';
    }

    async function setLoginState(isLoggedIn, user = null) {
        document.getElementById('loginContainer').style.display = isLoggedIn ? 'none' : 'flex';
        document.getElementById('appContainer').style.display = isLoggedIn ? 'block' : 'none';
        document.getElementById('manualLoginForm').style.display = 'block';
        document.getElementById('registrationForm').style.display = 'none';
        document.getElementById('loginError').textContent = '';
        
        if (isLoggedIn && user) { 
            const uid = user.uid;
            const email = user.email;
            repartidorUID = uid;
            window.currentRepartidorUID = uid;
            
            const repSnapshot = await get(ref(db, `repartidores_info/${repartidorUID}`));
            const repData = repSnapshot.val() || {};
            
            if (!repData.nombre || !repData.telefono_principal || !repData.direccion_residencia) {
                showRegistrationForm(email);
                return; 
            }
            
            repartidorNombre = repData.nombre;
            window.currentRepartidorNombre = repartidorNombre;
            
            await configurarPresenciaInicial();
            
            document.getElementById('repartidorName').textContent = repartidorNombre; 
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';

            mostrarModalPermisos();

            showSection('chatSection'); 
            listenForPedidos();
            listenForChat();
            
        } else {
            if (repartidorUID) {
                await marcarComoOffline();
            }
            
            detenerHeartbeat();
            detenerTrackingGPS();
            window.detenerSeguimiento();
            
            await liberarWakeLock();
            limpiarRecursos();
            
            repartidorUID = null;
            repartidorNombre = "Repartidor";
            window.currentRepartidorUID = null;
            window.currentRepartidorNombre = null;
            window.currentClienteID = null;
            
            pedidosActivos = {};
            
            if (timerInterval) clearInterval(timerInterval);
            updateQuickLoginUI(); 
        }
    }

    function updateQuickLoginUI() {
        const lastEmail = localStorage.getItem('lastRepartidorEmail');
        const lastName = localStorage.getItem('lastRepartidorName');
        const quickLoginArea = document.getElementById('quickLoginArea');
        if (lastEmail && lastName) {
            quickLoginArea.style.display = 'block';
            document.getElementById('quickLoginMessage').innerHTML = `<strong>¬øContinuar como ${lastName}?</strong>`;
        } else {
            quickLoginArea.style.display = 'none';
        }
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) await setLoginState(true, user);
        else await setLoginState(false);
    });

    document.getElementById('quickLoginBtn').addEventListener('click', async () => {
        const btn = document.getElementById('quickLoginBtn');
        const errorElement = document.getElementById('loginError');
        
        if (btn.disabled) return;
        
        btn.textContent = 'Conectando...';
        btn.disabled = true;
        errorElement.textContent = '';
        
        const repEmail = localStorage.getItem('lastRepartidorEmail');
        const repPassword = localStorage.getItem('lastRepartidorPassword');
        
        if (!repEmail || !repPassword) {
            errorElement.textContent = '‚ö†Ô∏è No hay sesi√≥n guardada';
            btn.textContent = 'Entrar R√°pido (Un Clic)';
            btn.disabled = false;
            return;
        }
        
        try { 
            await signInWithEmailAndPassword(auth, repEmail, repPassword);
        } catch (error) { 
            console.error('‚ùå Error login r√°pido:', error);
            localStorage.removeItem('lastRepartidorEmail');
            localStorage.removeItem('lastRepartidorPassword');
            localStorage.removeItem('lastRepartidorName');
            updateQuickLoginUI();
            errorElement.textContent = '‚ùå Sesi√≥n expirada. Inicia sesi√≥n nuevamente.';
        } finally {
            btn.textContent = 'Entrar R√°pido (Un Clic)';
            btn.disabled = false;
        }
    });
    
    document.getElementById('loginBtn').addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        const errorElement = document.getElementById('loginError');
        const loginBtn = document.getElementById('loginBtn');
        
        if (loginBtn.disabled) return;
        
        errorElement.textContent = '';
        
        if (!email || !password) {
            errorElement.textContent = '‚ö†Ô∏è Completa ambos campos';
            return;
        }
        
        if (password.length < 6) {
            errorElement.textContent = '‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres';
            return;
        }
        
        loginBtn.textContent = 'Iniciando...';
        loginBtn.disabled = true;
        
        try { 
            await signInWithEmailAndPassword(auth, email, password);
            localStorage.setItem('tempPassword', password);
        } catch (error) { 
            console.error('‚ùå Error login:', error);
            if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                errorElement.textContent = '‚ùå Email o contrase√±a incorrectos';
            } else if (error.code === 'auth/user-not-found') {
                errorElement.textContent = '‚ùå Usuario no encontrado';
            } else if (error.code === 'auth/too-many-requests') {
                errorElement.textContent = '‚ùå Demasiados intentos. Intenta m√°s tarde.';
            } else {
                errorElement.textContent = '‚ùå Error: ' + error.message;
            }
        } finally {
            loginBtn.textContent = 'Iniciar Sesi√≥n';
            loginBtn.disabled = false;
        }
    });

    document.getElementById('registerBtn').addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        const errorElement = document.getElementById('loginError');
        const registerBtn = document.getElementById('registerBtn');
        
        if (registerBtn.disabled) return;
        
        errorElement.textContent = '';
        
        if (!email || !password) {
            errorElement.textContent = '‚ö†Ô∏è Completa ambos campos';
            return;
        }
        
        if (password.length < 6) {
            errorElement.textContent = '‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres';
            return;
        }
        
        registerBtn.textContent = 'Registrando...';
        registerBtn.disabled = true;
        
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            localStorage.setItem('tempPassword', password);
            showRegistrationForm(email);
        } catch (error) { 
            console.error('‚ùå Error registro:', error);
            if (error.code === 'auth/email-already-in-use') {
                errorElement.textContent = '‚ùå Email ya registrado. Usa "Iniciar Sesi√≥n"';
            } else if (error.code === 'auth/invalid-email') {
                errorElement.textContent = '‚ùå Email inv√°lido';
            } else if (error.code === 'auth/weak-password') {
                errorElement.textContent = '‚ùå Contrase√±a muy d√©bil';
            } else {
                errorElement.textContent = '‚ùå Error: ' + error.message;
            }
        } finally {
            registerBtn.textContent = 'Registrarse (Crear Cuenta)';
            registerBtn.disabled = false;
        }
    });

    document.getElementById('completeRegBtn').addEventListener('click', async () => {
        const name = document.getElementById('regName').value.trim();
        const phone = document.getElementById('regPhone').value.trim();
        const address = document.getElementById('regAddress').value.trim();
        const secondaryPhone = document.getElementById('regSecondaryPhone').value.trim();
        
        if (!name || !phone || !address) { 
            alert('‚ö†Ô∏è Completa todos los campos obligatorios (*)');
            return; 
        }
        
        try {
            const repartidorData = {
                nombre: name, 
                telefono_principal: phone, 
                telefono_secundario: secondaryPhone || '',
                direccion_residencia: address, 
                email: auth.currentUser.email,
                fechaRegistro: Date.now(),
                online: true,
                ultimaConexion: Date.now(),
                lastSeen: Date.now()
            };
            
            await set(ref(db, `repartidores_info/${auth.currentUser.uid}`), repartidorData);
            
            saveQuickLoginData(auth.currentUser.email, localStorage.getItem('tempPassword'), name);
            await setLoginState(true, auth.currentUser);
            
        } catch (error) { 
            console.error('‚ùå Error al guardar informaci√≥n:', error);
            alert('‚ùå Error al guardar: ' + error.message);
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
        await signOut(auth);
    });
    
    document.getElementById('regLogoutBtn').addEventListener('click', async () => {
        await signOut(auth);
    });

    // ========================================
    // SISTEMA DE ACTUALIZACIONES
    // ========================================
    
    function compararVersiones(v1, v2) {
        const partes1 = v1.split('.').map(Number);
        const partes2 = v2.split('.').map(Number);
        
        for (let i = 0; i < 3; i++) {
            if (partes1[i] > partes2[i]) return 1;
            if (partes1[i] < partes2[i]) return -1;
        }
        return 0;
    }

    async function verificarActualizacion() {
        try {
            const versionRef = ref(db, 'app_config/version_actual');
            const snapshot = await get(versionRef);
            
            if (!snapshot.exists()) {
                return;
            }
            
            const configVersion = snapshot.val();
            const versionServidor = configVersion.numero || "1.0.0";
            const changelog = configVersion.changelog || ["Mejoras generales"];
            const obligatoria = configVersion.obligatoria || false;
            
            if (compararVersiones(versionServidor, APP_VERSION) > 0) {
                const recordarHasta = localStorage.getItem('recordar_actualizacion_hasta');
                const ahora = Date.now();
                
                if (obligatoria || !recordarHasta || ahora > parseInt(recordarHasta)) {
                    mostrarActualizacion(versionServidor, changelog, obligatoria);
                } else {
                    document.getElementById('versionBadge').classList.add('show');
                }
            }
            
        } catch (error) {
            console.error('‚ùå Error al verificar actualizaci√≥n:', error);
        }
    }

    function mostrarActualizacion(nuevaVersion, changelog, obligatoria) {
        document.getElementById('currentVersion').textContent = APP_VERSION;
        document.getElementById('newVersion').textContent = nuevaVersion;
        
        const changelogList = document.getElementById('changelogList');
        changelogList.innerHTML = '';
        
        changelog.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            changelogList.appendChild(li);
        });
        
        if (obligatoria) {
            document.querySelector('.btn-later').style.display = 'none';
        } else {
            document.querySelector('.btn-later').style.display = 'block';
        }
        
        document.getElementById('updateModal').classList.add('show');
        document.getElementById('versionBadge').classList.add('show');
    }

    window.mostrarModalActualizacion = function() {
        document.getElementById('updateModal').classList.add('show');
    }

    window.actualizarApp = function() {
        document.getElementById('loadingOverlay').classList.add('show');
        
        setTimeout(() => {
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            localStorage.removeItem('recordar_actualizacion_hasta');
            window.location.reload(true);
        }, 2000);
    }

    window.recordarMasTarde = function() {
        const seisHoras = 6 * 60 * 60 * 1000;
        const recordarHasta = Date.now() + seisHoras;
        
        localStorage.setItem('recordar_actualizacion_hasta', recordarHasta.toString());
        
        document.getElementById('updateModal').classList.remove('show');
        document.getElementById('versionBadge').classList.add('show');
    }

    onValue(ref(db, 'app_config/version_actual'), (snapshot) => {
        if (snapshot.exists()) {
            const configVersion = snapshot.val();
            const versionServidor = configVersion.numero;
            
            if (compararVersiones(versionServidor, APP_VERSION) > 0) {
                document.getElementById('versionBadge').classList.add('show');
            }
        }
    });

    // ========================================
    // EVENTOS DE VISIBILIDAD Y CONECTIVIDAD
    // ========================================

    document.addEventListener('visibilitychange', async () => {
        if (document.hidden) {
            isBackgroundMode = true;
            
            if (sessionActive && repartidorUID) {
                if (!backgroundGeoInterval) {
                    iniciarBackgroundGeolocation();
                }
                
                try {
                    await update(ref(db, `repartidores_info/${repartidorUID}`), {
                        backgroundMode: true,
                        lastBackgroundTimestamp: Date.now()
                    });
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error al marcar background:', error);
                }
            }
        } else {
            isBackgroundMode = false;
            
            if (sessionActive && repartidorUID) {
                await marcarComoOnline();
                
                if (!isTrackingEnabled && permisosUbicacionOtorgado) {
                    await iniciarTrackingGPSAutomatico();
                }
                
                if (wakeLock === null && isWakeLockSupported) {
                    await solicitarWakeLock();
                }

                if (!heartbeatInterval) {
                    await iniciarHeartbeatPrincipal();
                }
                
                try {
                    await update(ref(db, `repartidores_info/${repartidorUID}`), {
                        backgroundMode: false,
                        lastForegroundTimestamp: Date.now()
                    });
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error al marcar foreground:', error);
                }
            }
        }
    });

    window.addEventListener('online', async () => {
        if (sessionActive && repartidorUID) {
            await marcarComoOnline();
            
            if (!isTrackingEnabled && permisosUbicacionOtorgado) {
                await iniciarTrackingGPSAutomatico();
            }

            if (!heartbeatInterval) {
                await iniciarHeartbeatPrincipal();
            }
            
            if (!backgroundGeoInterval && sessionActive) {
                iniciarBackgroundGeolocation();
            }
        }
    });

    window.addEventListener('offline', () => {
        actualizarIndicadorConexion(false);
    });

    window.addEventListener('beforeunload', (event) => {
        if (Object.keys(pedidosActivos).length > 0) {
            const mensaje = '‚ö†Ô∏è Tienes pedidos activos. ¬øSeguro que quieres salir?';
            event.preventDefault();
            event.returnValue = mensaje;
            return mensaje;
        }
    });

    // ========================================
    // MONITOREO Y MANTENIMIENTO
    // ========================================

    setInterval(() => {
        if (sessionActive && repartidorUID) {
            if (!heartbeatInterval) {
                iniciarHeartbeatPrincipal();
            }
            
            if (!isTrackingEnabled && sessionActive && permisosUbicacionOtorgado) {
                iniciarTrackingGPSAutomatico();
            }
            
            if (!backgroundGeoInterval && sessionActive) {
                iniciarBackgroundGeolocation();
            }
        }
    }, 30000);

    // ========================================
    // INICIALIZACI√ìN FINAL
    // ========================================

    window.addEventListener('load', () => {
        console.log('üöÄ Servi Aliados - Panel Repartidor v' + APP_VERSION);
        console.log('üîç Caracter√≠sticas:');
        console.log('   ‚úÖ GPS CORREGIDO: Formato lon (NO lng)');
        console.log('   ‚úÖ üî• BOT√ìN COMPLETAR PEDIDO CORREGIDO');
        console.log('   ‚úÖ üó∫Ô∏è MAPA DEL CLIENTE MEJORADO');
        console.log('   ‚úÖ üìç DEBUGGING COMPLETO ACTIVADO');
        console.log('   ‚úÖ Sistema de seguimiento cliente ‚Üî repartidor');
        
        setTimeout(verificarActualizacion, 2000);
        updateQuickLoginUI();
    });

    setInterval(verificarActualizacion, 30 * 60 * 1000);
    
    // ========================================
    // üÜï BOT√ìN VER MAPA CLIENTE
    // ========================================
    
    document.getElementById('verMapaBtn').addEventListener('click', () => {
        const mapaContainer = document.getElementById('mapa-cliente-container');
        
        if (mapaContainer.style.display === 'none' || !mapaContainer.style.display) {
            const asignadosCount = parseInt(document.getElementById('asignadosCount').textContent);
            
            if (asignadosCount > 0) {
                showSection('asignadosSection');
                mapaContainer.style.display = 'block';
                
                if (!mapaCliente) {
                    inicializarMapaCliente();
                }
                
                setTimeout(() => {
                    if (mapaCliente) {
                        mapaCliente.invalidateSize();
                    }
                }, 200);
                
                document.getElementById('verMapaBtn').textContent = 'üó∫Ô∏è Ocultar Mapa';
            } else {
                alert('‚ö†Ô∏è No tienes pedidos asignados.\n\nAcepta un pedido primero para ver la ubicaci√≥n del cliente.');
            }
        } else {
            mapaContainer.style.display = 'none';
            document.getElementById('verMapaBtn').textContent = 'üó∫Ô∏è Ver Mapa Cliente';
        }
    });
</script>
</body>
</html>
